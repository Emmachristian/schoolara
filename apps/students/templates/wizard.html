{% extends "base.html" %}
{% load static %}

{% block extra_css %}
    <link href="{% static 'vendors/smartwizard/dist/css/smart_wizard.min.css' %}" rel="stylesheet">
    <style>
        .form-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }
        .form-section-title:first-child {
            margin-top: 0;
        }
        .progress-bar-wrapper {
            margin-bottom: 2rem;
        }
        .step-indicator {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }
        .errorlist {
            list-style: none;
            padding: 0;
            margin: 0.25rem 0 0 0;
        }
        .errorlist li {
            color: #dc3545;
            font-size: 0.875rem;
        }
        .form-control.is-invalid {
            border-color: #dc3545;
        }

        /* Horizontal radio buttons */
        #id_basic_info-gender {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        
        #id_basic_info-gender label {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            font-weight: normal;
            cursor: pointer;
        }
        
        #id_basic_info-gender input[type="radio"] {
            margin-right: 0.5rem;
            cursor: pointer;
        }
    </style>
{% endblock %}

{% block content %}
<div class="app-page-title">
    <div class="page-title-wrapper">
        <div class="page-title-heading">
            <div class="page-title-icon">
                <i class="pe-7s-study icon-gradient bg-happy-itmeo"></i>
            </div>
            <div>
                Student Admission
                <div class="page-title-subheading">Complete the student admission process in six simple steps</div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-12 col-md-12">
        <div class="main-card mb-3 card">
            <div class="card-body">
                <!-- Progress Indicator -->
                <div class="progress-bar-wrapper">
                    <div class="step-indicator">
                        <strong>Step {{ wizard.steps.step1 }} of {{ wizard.steps.count }}</strong>: 
                        {{ current_step_name }}
                    </div>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: {{ progress_percentage }}%"
                             aria-valuenow="{{ progress_percentage }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{ progress_percentage|floatformat:0 }}%
                        </div>
                    </div>
                </div>

                <!-- Wizard Form -->
                <form method="post" action="{% url 'students:student_create' %}" enctype="multipart/form-data" novalidate>
                    {% csrf_token %}
                    {{ wizard.management_form }}
                    
                    {% if wizard.form.forms %}
                        {{ wizard.form.management_form }}
                    {% endif %}

                    <!-- Display form errors -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger" role="alert">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}

                    <!-- Step 1: Basic Information -->
                    {% if wizard.steps.current == 'basic_info' %}

                        <div class="form-section-title">Personal Details</div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">First Name <span class="text-danger">*</span></label>
                                    {{ form.first_name }}
                                    {% if form.first_name.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.first_name.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Middle Name</label>
                                    {{ form.middle_name }}
                                    {% if form.middle_name.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.middle_name.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Last Name <span class="text-danger">*</span></label>
                                    {{ form.last_name }}
                                    {% if form.last_name.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.last_name.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
                                    {{ form.date_of_birth }}
                                    {% if form.date_of_birth.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.date_of_birth.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Gender <span class="text-danger">*</span></label>
                                    <div class="mt-2">
                                        {{ form.gender }}
                                    </div>
                                    {% if form.gender.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.gender.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="form-section-title">Student Identity</div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Admission Date <span class="text-danger">*</span></label>
                                    {{ form.admission_date }}
                                    {% if form.admission_date.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.admission_date.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">National Student Number</label>
                                    {{ form.national_student_number }}
                                    {% if form.national_student_number.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.national_student_number.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Birth Certificate Number</label>
                                    {{ form.birth_certificate_number }}
                                    {% if form.birth_certificate_number.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.birth_certificate_number.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="form-section-title">Demographics & Cultural Information</div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Nationality</label>
                                    {{ form.nationality }}
                                    {% if form.nationality.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.nationality.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Ethnicity</label>
                                    {{ form.ethnicity }}
                                    {% if form.ethnicity.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.ethnicity.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Religious Affiliation</label>
                                    {{ form.religious_affiliation }}
                                    {% if form.religious_affiliation.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.religious_affiliation.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Birth Place</label>
                                    {{ form.birth_place }}
                                    {% if form.birth_place.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.birth_place.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Birth Country</label>
                                    {{ form.birth_country }}
                                    {% if form.birth_country.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.birth_country.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Step 2: Contact & Address -->
                    {% if wizard.steps.current == 'contact_info' %}
                        <div class="form-section-title">Contact Information</div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Personal Email</label>
                                    {{ form.personal_email }}
                                    {% if form.personal_email.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.personal_email.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Phone Number</label>
                                    {{ form.phone_number }}
                                    {% if form.phone_number.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.phone_number.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="form-section-title">Address Information</div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Home Address <span class="text-danger">*</span></label>
                                    {{ form.home_address }}
                                    {% if form.home_address.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.home_address.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Mailing Address</label>
                                    {{ form.mailing_address }}
                                    {% if form.mailing_address.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.mailing_address.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">District</label>
                                    {{ form.district }}
                                    {% if form.district.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.district.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Region</label>
                                    {{ form.region }}
                                    {% if form.region.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.region.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Country of Residence</label>
                                    {{ form.country_of_residence }}
                                    {% if form.country_of_residence.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.country_of_residence.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="form-section-title">Transportation Information</div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="position-relative mb-3">
                                    <div class="form-check">
                                        {{ form.transportation_required }}
                                        <label class="form-check-label" for="{{ form.transportation_required.id_for_label }}">
                                            Transportation Required
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="transport-fields" style="display: none;">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="position-relative mb-3">
                                        <label class="form-label">Transport Route</label>
                                        {{ form.transport_route }}
                                        {% if form.transport_route.errors %}
                                            <ul class="errorlist">
                                                {% for error in form.transport_route.errors %}<li>{{ error }}</li>{% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="position-relative mb-3">
                                        <label class="form-label">Pickup Point</label>
                                        {{ form.pickup_point }}
                                        {% if form.pickup_point.errors %}
                                            <ul class="errorlist">
                                                {% for error in form.pickup_point.errors %}<li>{{ error }}</li>{% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="position-relative mb-3">
                                        <label class="form-label">Pickup Time</label>
                                        {{ form.pickup_time }}
                                        {% if form.pickup_time.errors %}
                                            <ul class="errorlist">
                                                {% for error in form.pickup_time.errors %}<li>{{ error }}</li>{% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Step 3: Academic Information -->
                    {% if wizard.steps.current == 'academic_info' %}
                        <div class="form-section-title">Current Academic Status</div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Admission Academic Level <span class="text-danger">*</span></label>
                                    {{ form.admission_academic_level }}
                                    <small class="form-text text-muted">{{ form.admission_academic_level.help_text }}</small>
                                    {% if form.admission_academic_level.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.admission_academic_level.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Current Academic Level <span class="text-danger">*</span></label>
                                    {{ form.current_academic_level }}
                                    <small class="form-text text-muted">{{ form.current_academic_level.help_text }}</small>
                                    {% if form.current_academic_level.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.current_academic_level.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Enrollment Status <span class="text-danger">*</span></label>
                                    {{ form.enrollment_status }}
                                    {% if form.enrollment_status.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.enrollment_status.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="form-section-title">Previous Education</div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Previous School</label>
                                    {{ form.previous_school }}
                                    {% if form.previous_school.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.previous_school.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Previous Academic Level</label>
                                    {{ form.previous_academic_level }}
                                    {% if form.previous_academic_level.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.previous_academic_level.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Previous School Address</label>
                                    {{ form.previous_school_address }}
                                    {% if form.previous_school_address.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.previous_school_address.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Transfer Certificate Number</label>
                                    {{ form.transfer_certificate_number }}
                                    {% if form.transfer_certificate_number.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.transfer_certificate_number.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Previous School Completion Date</label>
                                    {{ form.previous_school_completion_date }}
                                    {% if form.previous_school_completion_date.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.previous_school_completion_date.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Transfer Reason</label>
                                    {{ form.transfer_reason }}
                                    {% if form.transfer_reason.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.transfer_reason.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Step 4: Health & Medical -->
                    {% if wizard.steps.current == 'health_info' %}
                        <div class="form-section-title">Basic Health Information</div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Health Condition</label>
                                    {{ form.health_condition }}
                                    {% if form.health_condition.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.health_condition.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Blood Type</label>
                                    {{ form.blood_type }}
                                    {% if form.blood_type.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.blood_type.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Emergency Medical Contact</label>
                                    {{ form.emergency_medical_contact }}
                                    {% if form.emergency_medical_contact.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.emergency_medical_contact.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="form-section-title">Medical Details</div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Medical Conditions</label>
                                    {{ form.medical_conditions }}
                                    {% if form.medical_conditions.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.medical_conditions.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Allergies</label>
                                    {{ form.allergies }}
                                    {% if form.allergies.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.allergies.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Medications</label>
                                    {{ form.medications }}
                                    {% if form.medications.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.medications.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Special Medical Needs</label>
                                    {{ form.special_medical_needs }}
                                    {% if form.special_medical_needs.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.special_medical_needs.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="form-section-title">Insurance & Hospital</div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Preferred Hospital</label>
                                    {{ form.preferred_hospital }}
                                    {% if form.preferred_hospital.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.preferred_hospital.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Medical Insurance</label>
                                    {{ form.medical_insurance }}
                                    {% if form.medical_insurance.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.medical_insurance.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Insurance Policy Number</label>
                                    {{ form.insurance_policy_number }}
                                    {% if form.insurance_policy_number.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.insurance_policy_number.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="form-section-title">Special Needs & Accommodations</div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="position-relative mb-3">
                                    <div class="form-check">
                                        {{ form.has_special_needs }}
                                        <label class="form-check-label" for="{{ form.has_special_needs.id_for_label }}">
                                            Has Special Needs
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="special-needs-fields" style="display: none;">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="position-relative mb-3">
                                        <label class="form-label">Special Needs Description</label>
                                        {{ form.special_needs_description }}
                                        {% if form.special_needs_description.errors %}
                                            <ul class="errorlist">
                                                {% for error in form.special_needs_description.errors %}<li>{{ error }}</li>{% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="position-relative mb-3">
                                        <label class="form-label">Learning Disabilities</label>
                                        {{ form.learning_disabilities }}
                                        {% if form.learning_disabilities.errors %}
                                            <ul class="errorlist">
                                                {% for error in form.learning_disabilities.errors %}<li>{{ error }}</li>{% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="position-relative mb-3">
                                        <label class="form-label">Learning Accommodations</label>
                                        {{ form.learning_accommodations }}
                                        {% if form.learning_accommodations.errors %}
                                            <ul class="errorlist">
                                                {% for error in form.learning_accommodations.errors %}<li>{{ error }}</li>{% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-12">
                                <div class="position-relative mb-3">
                                    <div class="form-check">
                                        {{ form.requires_special_diet }}
                                        <label class="form-check-label" for="{{ form.requires_special_diet.id_for_label }}">
                                            Requires Special Diet
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="special-diet-fields" style="display: none;">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="position-relative mb-3">
                                        <label class="form-label">Special Diet Details</label>
                                        {{ form.special_diet_details }}
                                        {% if form.special_diet_details.errors %}
                                            <ul class="errorlist">
                                                {% for error in form.special_diet_details.errors %}<li>{{ error }}</li>{% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Step 5: Guardian Information -->
                    {% if wizard.steps.current == 'guardian_info' %}
                        <div class="form-section-title">Guardian Selection</div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Guardian Option <span class="text-danger">*</span></label>
                                    <div class="mt-2">
                                        {{ form.guardian_option }}
                                    </div>
                                    {% if form.guardian_option.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.guardian_option.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div id="existing-guardian-field" style="display: none;">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="position-relative mb-3">
                                        <label class="form-label">Select Existing Guardian <span class="text-danger">*</span></label>
                                        {{ form.existing_guardian }}
                                        {% if form.existing_guardian.errors %}
                                            <ul class="errorlist">
                                                {% for error in form.existing_guardian.errors %}<li>{{ error }}</li>{% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="new-guardian-fields" style="display: none;">
                            <div class="form-section-title">New Guardian Information</div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="position-relative mb-3">
                                        <label class="form-label">Guardian First Name <span class="text-danger">*</span></label>
                                        {{ form.guardian_first_name }}
                                        {% if form.guardian_first_name.errors %}
                                            <ul class="errorlist">
                                                {% for error in form.guardian_first_name.errors %}<li>{{ error }}</li>{% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="position-relative mb-3">
                                        <label class="form-label">Guardian Last Name <span class="text-danger">*</span></label>
                                        {{ form.guardian_last_name }}
                                        {% if form.guardian_last_name.errors %}
                                            <ul class="errorlist">
                                                {% for error in form.guardian_last_name.errors %}<li>{{ error }}</li>{% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="position-relative mb-3">
                                        <label class="form-label">Guardian Phone <span class="text-danger">*</span></label>
                                        {{ form.guardian_phone }}
                                        {% if form.guardian_phone.errors %}
                                            <ul class="errorlist">
                                                {% for error in form.guardian_phone.errors %}<li>{{ error }}</li>{% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="position-relative mb-3">
                                        <label class="form-label">Guardian Email</label>
                                        {{ form.guardian_email }}
                                        {% if form.guardian_email.errors %}
                                            <ul class="errorlist">
                                                {% for error in form.guardian_email.errors %}<li>{{ error }}</li>{% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12">
                                    <div class="position-relative mb-3">
                                        <label class="form-label">Guardian Address</label>
                                        {{ form.guardian_address }}
                                        {% if form.guardian_address.errors %}
                                            <ul class="errorlist">
                                                {% for error in form.guardian_address.errors %}<li>{{ error }}</li>{% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="position-relative mb-3">
                                        <label class="form-label">Guardian Occupation</label>
                                        {{ form.guardian_occupation }}
                                        {% if form.guardian_occupation.errors %}
                                            <ul class="errorlist">
                                                {% for error in form.guardian_occupation.errors %}<li>{{ error }}</li>{% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section-title">Relationship</div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Relationship to Student <span class="text-danger">*</span></label>
                                    {{ form.relationship }}
                                    {% if form.relationship.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.relationship.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Step 6: Confirmation -->
                    {% if wizard.steps.current == 'confirmation' %}
                        <div class="text-center py-5">
                            <h3 class="mt-4">Review Your Information</h3>
                            <div class="mt-3 mb-3">
                                <p class="text-muted">Please review all the information you've entered before submitting.</p>
                            </div>
                        </div>

                        <!-- Basic Information Review -->
                        {% if basic_data %}
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong>Basic Information</strong>
                                <button type="submit" name="wizard_goto_step" value="basic_info" 
                                        class="btn btn-sm btn-outline-primary float-end">Edit</button>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Name:</strong> {{ basic_data.first_name }} {{ basic_data.middle_name|default:"" }} {{ basic_data.last_name }}</p>
                                        <p><strong>Date of Birth:</strong> {{ basic_data.date_of_birth|date:"F d, Y" }}</p>
                                        <p><strong>Gender:</strong> {{ basic_data.get_gender_display|default:basic_data.gender }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Admission Date:</strong> {{ basic_data.admission_date|date:"F d, Y" }}</p>
                                        <p><strong>Nationality:</strong> {{ basic_data.nationality|default:"Not specified" }}</p>
                                        <p><strong>Birth Place:</strong> {{ basic_data.birth_place|default:"Not specified" }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Contact Information Review -->
                        {% if contact_data %}
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong>Contact Information</strong>
                                <button type="submit" name="wizard_goto_step" value="contact_info" 
                                        class="btn btn-sm btn-outline-primary float-end">Edit</button>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Email:</strong> {{ contact_data.personal_email|default:"Not provided" }}</p>
                                        <p><strong>Phone:</strong> {{ contact_data.phone_number|default:"Not provided" }}</p>
                                        <p><strong>Home Address:</strong> {{ contact_data.home_address }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>District:</strong> {{ contact_data.district|default:"Not specified" }}</p>
                                        <p><strong>Region:</strong> {{ contact_data.region|default:"Not specified" }}</p>
                                        <p><strong>Transportation:</strong> {% if contact_data.transportation_required %}Yes{% else %}No{% endif %}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Academic Information Review -->
                        {% if academic_data %}
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong>Academic Information</strong>
                                <button type="submit" name="wizard_goto_step" value="academic_info" 
                                        class="btn btn-sm btn-outline-primary float-end">Edit</button>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Admission Level:</strong> {{ academic_data.admission_academic_level }}</p>
                                        <p><strong>Current Level:</strong> {{ academic_data.current_academic_level }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Enrollment Status:</strong> {{ academic_data.get_enrollment_status_display|default:academic_data.enrollment_status }}</p>
                                        <p><strong>Previous School:</strong> {{ academic_data.previous_school|default:"Not specified" }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Guardian Information Review -->
                        {% if guardian_data %}
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong>Guardian Information</strong>
                                <button type="submit" name="wizard_goto_step" value="guardian_info" 
                                        class="btn btn-sm btn-outline-primary float-end">Edit</button>
                            </div>
                            <div class="card-body">
                                {% if guardian_data.guardian_option == 'new' %}
                                    <p><strong>Guardian:</strong> {{ guardian_data.guardian_first_name }} {{ guardian_data.guardian_last_name }}</p>
                                    <p><strong>Phone:</strong> {{ guardian_data.guardian_phone }}</p>
                                    <p><strong>Email:</strong> {{ guardian_data.guardian_email|default:"Not provided" }}</p>
                                {% else %}
                                    <p><strong>Guardian:</strong> {{ guardian_data.existing_guardian }}</p>
                                {% endif %}
                                <p><strong>Relationship:</strong> {{ guardian_data.relationship }}</p>
                            </div>
                        </div>
                        {% endif %}

                        <div class="alert alert-info">
                            <i class="fa fa-info-circle"></i> If you need to make changes, click the "Edit" button on any section above, or use the "Previous" button below.
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="position-relative mb-3">
                                    <div class="form-check">
                                        {{ form.confirm_creation }}
                                        <label class="form-check-label" for="{{ form.confirm_creation.id_for_label }}">
                                            I confirm that all the information provided is correct <span class="text-danger">*</span>
                                        </label>
                                    </div>
                                    {% if form.confirm_creation.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.confirm_creation.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="position-relative mb-3">
                                    <label class="form-label">Additional Notes</label>
                                    {{ form.additional_notes }}
                                    <small class="form-text text-muted">{{ form.additional_notes.help_text }}</small>
                                    {% if form.additional_notes.errors %}
                                        <ul class="errorlist">
                                            {% for error in form.additional_notes.errors %}<li>{{ error }}</li>{% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <div class="divider mt-4"></div>
                    
                    <!-- Navigation Buttons -->
                    <div class="clearfix">
                        {% if wizard.steps.prev %}
                        <button type="submit" name="wizard_goto_step" value="{{ wizard.steps.prev }}" 
                                class="btn-shadow float-start btn-wide btn-pill btn btn-outline-secondary">
                            Previous
                        </button>
                        {% endif %}

                        {% if wizard.steps.current != 'confirmation' %}
                        <button type="submit" class="btn-shadow btn-wide float-end btn-pill btn-hover-shine btn btn-primary">
                            Next
                        </button>
                        {% else %}
                        <button type="submit" class="btn-shadow btn-wide float-end btn-pill btn-hover-shine btn btn-success btn-lg">
                            <i class="pe-7s-check"></i> Submit Application
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script type="text/javascript" src="{% static 'vendors/smartwizard/dist/js/jquery.smartWizard.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/form-components/form-wizard.js' %}"></script>
<script type="text/javascript" src="{% static 'js/form-components/toggle-switch.js' %}"></script>
<script type="text/javascript">
    $(document).ready(function() {
        // Toggle transport fields based on checkbox
        function toggleTransportFields() {
            if ($('#id_contact_info-transportation_required').is(':checked')) {
                $('#transport-fields').slideDown();
            } else {
                $('#transport-fields').slideUp();
            }
        }

        // Toggle special needs fields
        function toggleSpecialNeedsFields() {
            if ($('#id_health_info-has_special_needs').is(':checked')) {
                $('#special-needs-fields').slideDown();
            } else {
                $('#special-needs-fields').slideUp();
            }
        }

        // Toggle special diet fields
        function toggleSpecialDietFields() {
            if ($('#id_health_info-requires_special_diet').is(':checked')) {
                $('#special-diet-fields').slideDown();
            } else {
                $('#special-diet-fields').slideUp();
            }
        }

        // Toggle guardian fields
        function toggleGuardianFields() {
            var guardianOption = $('input[name="guardian_info-guardian_option"]:checked').val();
            if (guardianOption === 'new') {
                $('#new-guardian-fields').slideDown();
                $('#existing-guardian-field').slideUp();
            } else {
                $('#new-guardian-fields').slideUp();
                $('#existing-guardian-field').slideDown();
            }
        }

        // Initial checks
        toggleTransportFields();
        toggleSpecialNeedsFields();
        toggleSpecialDietFields();
        toggleGuardianFields();

        // Listen for changes
        $('#id_contact_info-transportation_required').on('change', toggleTransportFields);
        $('#id_health_info-has_special_needs').on('change', toggleSpecialNeedsFields);
        $('#id_health_info-requires_special_diet').on('change', toggleSpecialDietFields);
        $('input[name="guardian_info-guardian_option"]').on('change', toggleGuardianFields);
    });
</script>
{% endblock %}