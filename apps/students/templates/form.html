{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<style>
    .form-section {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        border: none;
    }
    
    .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        margin: 0;
    }
    
    .section-header h6 {
        margin: 0;
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .section-header p {
        margin: 5px 0 0 0;
        opacity: 0.9;
        font-size: 0.9rem;
    }
    
    .section-body {
        padding: 25px;
    }
    
    .form-floating {
        margin-bottom: 1.2rem;
    }
    
    .form-floating label {
        color: #6c757d;
        font-weight: 500;
    }
    
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.15);
    }
    
    .required-field::after {
        content: " *";
        color: #dc3545;
        font-weight: bold;
    }
    
    .form-help {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }
    
    .form-help h6 {
        color: #1976d2;
        margin-bottom: 10px;
    }
    
    .current-value {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 15px;
        border-left: 4px solid #28a745;
    }
    
    .current-value-label {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .current-value-text {
        font-size: 1.1rem;
        color: #212529;
        margin-top: 5px;
    }
    
    .btn-save-group {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        margin-top: 20px;
        border: 1px solid #dee2e6;
    }
    
    /* Profile Image Styling */
    .profile-image-container {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto 20px;
    }

    .profile-image-container .profile-avatar {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 50%;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        border: 3px solid #fff;
    }

    .avatar-placeholder {
        width: 120px;
        height: 120px;
        background-color: #f8f9fa;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 3px solid #fff;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .avatar-title {
        font-size: 48px;
        color: #556ee6;
        font-weight: 500;
    }

    .profile-image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 120px;
        height: 120px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        cursor: pointer;
    }

    .profile-image-container:hover .profile-image-overlay {
        opacity: 1;
    }

    .profile-image-overlay i {
        color: white;
        font-size: 24px;
    }

    /* Image Cropper Modal Styling */
    #image-container {
        max-width: 100%;
        margin: 0 auto;
    }

    #imagePreview {
        max-width: 100%;
        max-height: 400px;
        display: block;
        margin: 0 auto;
    }

    .cropper-container {
        margin: 0 auto;
    }
    
    .change-indicator {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 4px;
    }
    
    .validation-summary {
        background-color: #f8d7da;
        border-left: 4px solid #dc3545;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }
    
    .field-group {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: #fdfdfe;
    }
    
    .field-group-header {
        font-weight: 600;
        color: #495057;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .image-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .image-upload-area:hover {
        border-color: #667eea;
        background-color: #f8f9ff;
    }

    .image-upload-area.dragover {
        border-color: #667eea;
        background-color: #f0f2ff;
    }

    .upload-icon {
        font-size: 3rem;
        color: #667eea;
        margin-bottom: 1rem;
    }

    .status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-active {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-suspended {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .status-withdrawn {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .status-graduated {
        background-color: #cce5ff;
        color: #004085;
        border: 1px solid #a6d2ff;
    }
    
    .disabled-field {
        opacity: 0.6;
        pointer-events: none;
    }

    .readonly-field {
        background-color: #f8f9fa !important;
        cursor: not-allowed;
    }
    
    .error-summary {
        background-color: #fff5f5;
        border: 1px solid #fed7d7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .error-summary h6 {
        color: #c53030;
        margin-bottom: 10px;
    }

    .error-list {
        margin: 0;
        padding-left: 20px;
    }

    .error-list li {
        color: #742a2a;
        margin-bottom: 5px;
    }

    .debug-info {
        background-color: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 15px;
        font-family: monospace;
        font-size: 12px;
    }
    
    @media (max-width: 768px) {
        .section-body {
            padding: 15px;
        }
        
        .btn-save-group {
            padding: 15px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="app-page-title">
    <div class="page-title-wrapper">
        <div class="page-title-heading">
            <div class="page-title-icon">
                <i class="pe-7s-user icon-gradient bg-mean-fruit"></i>
            </div>
            <div>
                {% if form.instance.pk %}Update Student{% else %}Add New Student{% endif %}
                <div class="page-title-subheading">
                    {% if form.instance.pk %}
                        Update information for {{ form.instance.get_full_name }} ({{ form.instance.admission_number }})
                    {% else %}
                        Add a new student to the system
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="page-title-actions">
            <div class="dropdown">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fa fa-ellipsis-v me-1"></i> Actions
                </button>
                <div class="dropdown-menu dropdown-menu-end">
                    {% if form.instance.pk %}
                        <a class="dropdown-item" href="">
                            <i class="fa fa-eye me-2"></i> View Profile
                        </a>
                        <a class="dropdown-item" href="">
                            <i class="fa fa-users me-2"></i> Manage Guardians
                        </a>
                        <a class="dropdown-item" href="">
                            <i class="fa fa-ruler me-2"></i> Measurements
                        </a>
                        <a class="dropdown-item" href="">
                            <i class="fa fa-file-alt me-2"></i> Documents
                        </a>
                        <div class="dropdown-divider"></div>
                    {% endif %}
                    <a class="dropdown-item" href="{% url 'students:student_list' %}">
                        <i class="fa fa-list me-2"></i> Back to Student List
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Form Help Section -->
<div class="form-help">
    <h6><i class="fa fa-info-circle me-1"></i> {% if form.instance.pk %}Update{% else %}Creation{% endif %} Guidelines</h6>
    <div class="row">
        <div class="col-md-6">
            <ul class="mb-0">
                <li><strong>Required fields</strong> are marked with an asterisk (*)</li>
                {% if form.instance.pk %}
                    <li><strong>Admission number</strong> cannot be changed after creation</li>
                    <li><strong>Academic level changes</strong> will be tracked in academic history</li>
                {% else %}
                    <li><strong>Admission number</strong> will be auto-generated if not provided</li>
                    <li><strong>Academic levels</strong> determine class placement options</li>
                {% endif %}
            </ul>
        </div>
        <div class="col-md-6">
            <ul class="mb-0">
                <li><strong>Profile photos</strong> should be clear headshots (max 5MB)</li>
                {% if form.instance.pk %}
                    <li><strong>Status changes</strong> will trigger notifications to guardians</li>
                    <li>Use "Save Changes" to apply all modifications</li>
                {% else %}
                    <li><strong>Guardian information</strong> can be added after student creation</li>
                    <li>Use "Save Student" to create the new record</li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>

<!-- Enhanced Error Display Section -->
{% if form.errors or form.non_field_errors %}
<div class="error-summary">
    <h6><i class="fa fa-exclamation-triangle me-2"></i>Please correct the following errors:</h6>
    
    {% if form.non_field_errors %}
        <div class="mb-3">
            <strong>Form Errors:</strong>
            <ul class="error-list">
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}
    
    {% if form.errors %}
        <div class="mb-3">
            <strong>Field Errors:</strong>
            <ul class="error-list">
                {% for field, errors in form.errors.items %}
                    {% if field != '__all__' %}
                        <li><strong>{{ field|title }}:</strong>
                            {% for error in errors %}
                                {{ error }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    {% endif %}
</div>
{% endif %}

<!-- Debug Information (only in development) -->
{% if debug %}
<div class="debug-info">
    <strong>Debug Information:</strong><br>
    Form Valid: {{ form.is_valid }}<br>
    Has Instance: {{ form.instance.pk|yesno:"Yes,No" }}<br>
    Request Method: {{ request.method }}<br>
    {% if form.instance.pk %}
        Student ID: {{ form.instance.pk }}<br>
        Admission Number: {{ form.instance.admission_number }}<br>
    {% endif %}
</div>
{% endif %}

<!-- Current Status Display (for updates only) -->
{% if form.instance.pk %}
<div class="current-value">
    <div class="row align-items-center">
        <div class="col-md-8">
            <div class="current-value-label">Current Student Status</div>
            <div class="current-value-text">
                <span class="status-badge status-{{ form.instance.enrollment_status }}">
                    {{ form.instance.get_enrollment_status_display }}
                </span>
                {% if form.instance.current_academic_level %}
                    in {{ form.instance.current_academic_level }}
                {% endif %}
                {% if form.instance.age %}
                    <small class="text-muted ms-2">Age: {{ form.instance.age }} years</small>
                {% endif %}
            </div>
        </div>
        <div class="col-md-4 text-end">
            <small class="text-muted">
                Admitted: {{ form.instance.admission_date|date:"M d, Y" }}<br>
                {% if form.instance.graduation_date %}
                    Graduated: {{ form.instance.graduation_date|date:"M d, Y" }}
                {% elif form.instance.withdrawal_date %}
                    Withdrawn: {{ form.instance.withdrawal_date|date:"M d, Y" }}
                {% endif %}
            </small>
        </div>
    </div>
</div>
{% endif %}

<!-- Main Form -->
<form method="post" enctype="multipart/form-data" id="student-update-form" novalidate>
    {% csrf_token %}
    
    <!-- Basic Information Section -->
    <div class="form-section">
        <div class="section-header">
            <h6><i class="fa fa-user me-2"></i>Basic Information</h6>
            <p>Personal details and identification information</p>
        </div>
        <div class="section-body">
            <!-- Admission Number -->
            <div class="form-floating">
                {% if form.instance.pk %}
                    {{ form.admission_number|add_class:"form-control readonly-field" }}
                {% else %}
                    {{ form.admission_number|add_class:"form-control" }}
                {% endif %}
                <label for="{{ form.admission_number.id_for_label }}" class="{% if form.admission_number.field.required %}required-field{% endif %}">Admission Number</label>
                {% if form.admission_number.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.admission_number.errors %}
                            {{ error }}{% if not forloop.last %}<br>{% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
                {% if form.instance.pk %}
                    <div class="form-text">Admission number cannot be changed after creation</div>
                {% else %}
                    <div class="form-text">Leave blank to auto-generate</div>
                {% endif %}
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.first_name|add_class:"form-control" }}
                        <label for="{{ form.first_name.id_for_label }}" class="{% if form.first_name.field.required %}required-field{% endif %}">First Name</label>
                        {% if form.first_name.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.first_name.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.middle_name|add_class:"form-control" }}
                        <label for="{{ form.middle_name.id_for_label }}">Middle Name</label>
                        {% if form.middle_name.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.middle_name.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.last_name|add_class:"form-control" }}
                        <label for="{{ form.last_name.id_for_label }}" class="{% if form.last_name.field.required %}required-field{% endif %}">Last Name</label>
                        {% if form.last_name.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.last_name.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.date_of_birth|add_class:"form-control" }}
                        <label for="{{ form.date_of_birth.id_for_label }}" class="{% if form.date_of_birth.field.required %}required-field{% endif %}">Date of Birth</label>
                        {% if form.date_of_birth.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.date_of_birth.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.gender|add_class:"form-select" }}
                        <label for="{{ form.gender.id_for_label }}" class="{% if form.gender.field.required %}required-field{% endif %}">Gender</label>
                        {% if form.gender.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.gender.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.nationality|add_class:"form-select" }}
                        <label for="{{ form.nationality.id_for_label }}">Nationality</label>
                        {% if form.nationality.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.nationality.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.ethnicity|add_class:"form-control" }}
                        <label for="{{ form.ethnicity.id_for_label }}">Ethnicity</label>
                        {% if form.ethnicity.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.ethnicity.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.birth_place|add_class:"form-control" }}
                        <label for="{{ form.birth_place.id_for_label }}">Place of Birth</label>
                        {% if form.birth_place.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.birth_place.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.birth_country|add_class:"form-select" }}
                        <label for="{{ form.birth_country.id_for_label }}">Country of Birth</label>
                        {% if form.birth_country.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.birth_country.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.religious_affiliation|add_class:"form-select" }}
                        <label for="{{ form.religious_affiliation.id_for_label }}">Religious Affiliation</label>
                        {% if form.religious_affiliation.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.religious_affiliation.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Government Identifiers -->
            <div class="field-group">
                <div class="field-group-header">
                    <i class="fa fa-id-card me-2"></i>Government Identifiers
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.national_student_number|add_class:"form-control" }}
                            <label for="{{ form.national_student_number.id_for_label }}">National Student Number</label>
                            {% if form.national_student_number.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.national_student_number.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">EMIS/UPI number issued by Ministry of Education</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.birth_certificate_number|add_class:"form-control" }}
                            <label for="{{ form.birth_certificate_number.id_for_label }}">Birth Certificate Number</label>
                            {% if form.birth_certificate_number.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.birth_certificate_number.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Profile Photo -->
            <div class="field-group">
                <div class="field-group-header">
                    <i class="fa fa-camera me-2"></i>Profile Photo
                </div>
                <div class="row">
                    <div class="col-md-3 text-center">
                        <div class="profile-image-container mb-3">
                            {% if form.instance.photo %}
                                <img id="currentProfileImage" src="{{ form.instance.photo.url }}" alt="{{ form.instance.get_full_name }}" class="profile-avatar">
                            {% else %}
                                <div class="avatar-placeholder">
                                    <div class="avatar-title">
                                        {% if form.instance.first_name %}{{ form.instance.first_name|first }}{% endif %}{% if form.instance.last_name %}{{ form.instance.last_name|first }}{% endif %}
                                    </div>
                                </div>
                            {% endif %}
                            <div class="profile-image-overlay">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                        <div class="small text-muted">Click to change photo</div>
                    </div>
                    <div class="col-md-9">
                        <div class="mt-2">
                            <strong>Profile Photo</strong>
                            <div class="small text-muted mt-1">
                                Click on the image to update the student's photo.<br>
                                Supported formats: JPG, PNG, GIF (Max: 5MB)<br>
                                Recommended: Square image, minimum 200x200 pixels
                            </div>
                        </div>
                        <!-- Hidden file input for form submission -->
                        {{ form.photo|add_class:"d-none" }}
                        {% if form.photo.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.photo.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Academic Information Section -->
    <div class="form-section">
        <div class="section-header">
            <h6><i class="fa fa-graduation-cap me-2"></i>Academic Information</h6>
            <p>Academic levels, enrollment status, and academic dates</p>
        </div>
        <div class="section-body">
            <!-- Admission Information -->
            <div class="field-group">
                <div class="field-group-header">
                    <i class="fa fa-calendar me-2"></i>Admission Details
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.admission_date|add_class:"form-control" }}
                            <label for="{{ form.admission_date.id_for_label }}" class="{% if form.admission_date.field.required %}required-field{% endif %}">Admission Date</label>
                            {% if form.admission_date.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.admission_date.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.admission_academic_level|add_class:"form-select" }}
                            <label for="{{ form.admission_academic_level.id_for_label }}">Admission Academic Level</label>
                            {% if form.admission_academic_level.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.admission_academic_level.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Academic level at time of admission</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Current Academic Status -->
            <div class="field-group">
                <div class="field-group-header">
                    <i class="fa fa-school me-2"></i>Current Academic Status
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.current_academic_level|add_class:"form-select" }}
                            <label for="{{ form.current_academic_level.id_for_label }}">Current Academic Level</label>
                            {% if form.current_academic_level.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.current_academic_level.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.enrollment_status|add_class:"form-select" }}
                            <label for="{{ form.enrollment_status.id_for_label }}" class="{% if form.enrollment_status.field.required %}required-field{% endif %}">Enrollment Status</label>
                            {% if form.enrollment_status.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.enrollment_status.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Previous Education -->
            <div class="field-group">
                <div class="field-group-header">
                    <i class="fa fa-history me-2"></i>Previous Education
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.previous_school|add_class:"form-control" }}
                            <label for="{{ form.previous_school.id_for_label }}">Previous School</label>
                            {% if form.previous_school.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.previous_school.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.previous_academic_level|add_class:"form-select" }}
                            <label for="{{ form.previous_academic_level.id_for_label }}">Previous Academic Level</label>
                            {% if form.previous_academic_level.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.previous_academic_level.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Academic level completed at previous school</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-floating">
                    {{ form.previous_school_address|add_class:"form-control" }}
                    <label for="{{ form.previous_school_address.id_for_label }}">Previous School Address</label>
                    {% if form.previous_school_address.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.previous_school_address.errors %}
                                {{ error }}{% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.transfer_certificate_number|add_class:"form-control" }}
                            <label for="{{ form.transfer_certificate_number.id_for_label }}">Transfer Certificate Number</label>
                            {% if form.transfer_certificate_number.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.transfer_certificate_number.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.previous_school_completion_date|add_class:"form-control" }}
                            <label for="{{ form.previous_school_completion_date.id_for_label }}">Previous School Completion Date</label>
                            {% if form.previous_school_completion_date.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.previous_school_completion_date.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="form-floating">
                    {{ form.transfer_reason|add_class:"form-control" }}
                    <label for="{{ form.transfer_reason.id_for_label }}">Reason for Transfer</label>
                    {% if form.transfer_reason.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.transfer_reason.errors %}
                                {{ error }}{% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contact Information Section -->
    <div class="form-section">
        <div class="section-header">
            <h6><i class="fa fa-envelope me-2"></i>Contact Information</h6>
            <p>Address and contact details</p>
        </div>
        <div class="section-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.personal_email|add_class:"form-control" }}
                        <label for="{{ form.personal_email.id_for_label }}">Personal Email</label>
                        {% if form.personal_email.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.personal_email.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">Student's personal email (optional)</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.phone_number|add_class:"form-control" }}
                        <label for="{{ form.phone_number.id_for_label }}">Phone Number</label>
                        {% if form.phone_number.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.phone_number.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">Student's phone number (if applicable)</div>
                    </div>
                </div>
            </div>
            
            <div class="form-floating">
                {{ form.home_address|add_class:"form-control" }}
                <label for="{{ form.home_address.id_for_label }}" class="{% if form.home_address.field.required %}required-field{% endif %}">Home Address</label>
                {% if form.home_address.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.home_address.errors %}
                            {{ error }}{% if not forloop.last %}<br>{% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-floating">
                {{ form.mailing_address|add_class:"form-control" }}
                <label for="{{ form.mailing_address.id_for_label }}">Mailing Address</label>
                {% if form.mailing_address.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.mailing_address.errors %}
                            {{ error }}{% if not forloop.last %}<br>{% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
                <div class="form-text">Leave blank if same as home address</div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.district|add_class:"form-control" }}
                        <label for="{{ form.district.id_for_label }}">District</label>
                        {% if form.district.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.district.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.region|add_class:"form-control" }}
                        <label for="{{ form.region.id_for_label }}">Region/Province</label>
                        {% if form.region.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.region.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.country_of_residence|add_class:"form-select" }}
                        <label for="{{ form.country_of_residence.id_for_label }}">Country of Residence</label>
                        {% if form.country_of_residence.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.country_of_residence.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transportation Section -->
    <div class="form-section">
        <div class="section-header">
            <h6><i class="fa fa-bus me-2"></i>Transportation</h6>
            <p>Transport arrangements and pickup details</p>
        </div>
        <div class="section-body">
            <div class="form-check form-switch mb-3">
                {{ form.transportation_required|add_class:"form-check-input" }}
                <label class="form-check-label" for="{{ form.transportation_required.id_for_label }}">
                    <strong>Transportation Required</strong>
                    <small class="d-block text-muted">Check if student requires school transport</small>
                </label>
                {% if form.transportation_required.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.transportation_required.errors %}
                            {{ error }}{% if not forloop.last %}<br>{% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="row" id="transport-details">
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.transport_route|add_class:"form-control" }}
                        <label for="{{ form.transport_route.id_for_label }}">Transport Route</label>
                        {% if form.transport_route.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.transport_route.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.pickup_point|add_class:"form-control" }}
                        <label for="{{ form.pickup_point.id_for_label }}">Pickup Point</label>
                        {% if form.pickup_point.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.pickup_point.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.pickup_time|add_class:"form-control" }}
                        <label for="{{ form.pickup_time.id_for_label }}">Pickup Time</label>
                        {% if form.pickup_time.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.pickup_time.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Health Information Section -->
    <div class="form-section">
        <div class="section-header">
            <h6><i class="fa fa-heartbeat me-2"></i>Health Information</h6>
            <p>Medical information and health status</p>
        </div>
        <div class="section-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.health_condition|add_class:"form-select" }}
                        <label for="{{ form.health_condition.id_for_label }}">Health Condition</label>
                        {% if form.health_condition.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.health_condition.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.blood_type|add_class:"form-select" }}
                        <label for="{{ form.blood_type.id_for_label }}">Blood Type</label>
                        {% if form.blood_type.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.blood_type.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="form-floating">
                {{ form.medical_conditions|add_class:"form-control" }}
                <label for="{{ form.medical_conditions.id_for_label }}">Medical Conditions</label>
                {% if form.medical_conditions.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.medical_conditions.errors %}
                            {{ error }}{% if not forloop.last %}<br>{% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
                <div class="form-text">Any existing medical conditions or chronic illnesses</div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.allergies|add_class:"form-control" }}
                        <label for="{{ form.allergies.id_for_label }}">Allergies</label>
                        {% if form.allergies.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.allergies.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.medications|add_class:"form-control" }}
                        <label for="{{ form.medications.id_for_label }}">Current Medications</label>
                        {% if form.medications.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.medications.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="form-floating">
                {{ form.special_medical_needs|add_class:"form-control" }}
                <label for="{{ form.special_medical_needs.id_for_label }}">Special Medical Needs</label>
                {% if form.special_medical_needs.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.special_medical_needs.errors %}
                            {{ error }}{% if not forloop.last %}<br>{% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
                <div class="form-text">Special care instructions or medical requirements</div>
            </div>
            
            <!-- Emergency Medical Information -->
            <div class="field-group">
                <div class="field-group-header">
                    <i class="fa fa-ambulance me-2"></i>Emergency Medical Information
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.emergency_medical_contact|add_class:"form-control" }}
                            <label for="{{ form.emergency_medical_contact.id_for_label }}">Emergency Medical Contact</label>
                            {% if form.emergency_medical_contact.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.emergency_medical_contact.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.preferred_hospital|add_class:"form-control" }}
                            <label for="{{ form.preferred_hospital.id_for_label }}">Preferred Hospital</label>
                            {% if form.preferred_hospital.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.preferred_hospital.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.medical_insurance|add_class:"form-control" }}
                            <label for="{{ form.medical_insurance.id_for_label }}">Medical Insurance</label>
                            {% if form.medical_insurance.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.medical_insurance.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.insurance_policy_number|add_class:"form-control" }}
                            <label for="{{ form.insurance_policy_number.id_for_label }}">Insurance Policy Number</label>
                            {% if form.insurance_policy_number.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.insurance_policy_number.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Special Needs Section -->
    <div class="form-section">
        <div class="section-header">
            <h6><i class="fa fa-universal-access me-2"></i>Special Needs & Accommodations</h6>
            <p>Special requirements and learning accommodations</p>
        </div>
        <div class="section-body">
            <!-- Special Needs -->
            <div class="field-group">
                <div class="field-group-header">
                    <i class="fa fa-hand-holding-heart me-2"></i>Special Needs
                </div>
                <div class="form-check form-switch mb-3">
                    {{ form.has_special_needs|add_class:"form-check-input" }}
                    <label class="form-check-label" for="{{ form.has_special_needs.id_for_label }}">
                        <strong>Has Special Needs</strong>
                        <small class="d-block text-muted">Check if student has special needs requirements</small>
                    </label>
                    {% if form.has_special_needs.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.has_special_needs.errors %}
                                {{ error }}{% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="form-floating">
                    {{ form.special_needs_description|add_class:"form-control" }}
                    <label for="{{ form.special_needs_description.id_for_label }}">Special Needs Description</label>
                    {% if form.special_needs_description.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.special_needs_description.errors %}
                                {{ error }}{% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text">Detailed description of special needs and requirements</div>
                </div>
            </div>
            
            <!-- Special Diet -->
            <div class="field-group">
                <div class="field-group-header">
                    <i class="fa fa-utensils me-2"></i>Dietary Requirements
                </div>
                <div class="form-check form-switch mb-3">
                    {{ form.requires_special_diet|add_class:"form-check-input" }}
                    <label class="form-check-label" for="{{ form.requires_special_diet.id_for_label }}">
                        <strong>Requires Special Diet</strong>
                        <small class="d-block text-muted">Check if student has special dietary requirements</small>
                    </label>
                    {% if form.requires_special_diet.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.requires_special_diet.errors %}
                                {{ error }}{% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="form-floating">
                    {{ form.special_diet_details|add_class:"form-control" }}
                    <label for="{{ form.special_diet_details.id_for_label }}">Special Diet Details</label>
                    {% if form.special_diet_details.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.special_diet_details.errors %}
                                {{ error }}{% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text">Specific dietary restrictions, allergies, or requirements</div>
                </div>
            </div>
            
            <!-- Learning Accommodations -->
            <div class="field-group">
                <div class="field-group-header">
                    <i class="fa fa-brain me-2"></i>Learning Accommodations
                </div>
                <div class="form-floating">
                    {{ form.learning_disabilities|add_class:"form-control" }}
                    <label for="{{ form.learning_disabilities.id_for_label }}">Learning Disabilities</label>
                    {% if form.learning_disabilities.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.learning_disabilities.errors %}
                                {{ error }}{% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text">Any diagnosed learning disabilities or challenges</div>
                </div>
                
                <div class="form-floating">
                    {{ form.learning_accommodations|add_class:"form-control" }}
                    <label for="{{ form.learning_accommodations.id_for_label }}">Learning Accommodations</label>
                    {% if form.learning_accommodations.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.learning_accommodations.errors %}
                                {{ error }}{% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text">Required accommodations for learning and assessments</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Save Button Group -->
    <div class="btn-save-group">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                {% if form.instance.pk %}
                    <a href="" class="btn btn-outline-secondary">
                        <i class="fa fa-times me-1"></i> Cancel
                    </a>
                {% else %}
                    <a href="{% url 'students:student_list' %}" class="btn btn-outline-secondary">
                        <i class="fa fa-times me-1"></i> Cancel
                    </a>
                {% endif %}
                <a href="{% url 'students:student_list' %}" class="btn btn-outline-info ms-2">
                    <i class="fa fa-list me-1"></i> Back to List
                </a>
            </div>
            <div>
                <button type="button" class="btn btn-outline-warning me-2" onclick="resetForm()">
                    <i class="fa fa-undo me-1"></i> Reset Changes
                </button>
                <button type="submit" class="btn btn-primary" id="save-btn">
                    <span class="spinner-border spinner-border-sm me-1" style="display: none;" id="save-spinner"></span>
                    <i class="fa fa-save me-1" id="save-icon"></i>
                    {% if form.instance.pk %}Save Changes{% else %}Save Student{% endif %}
                </button>
            </div>
        </div>
    </div>
</form>

<!-- Profile Image Modal -->
<div class="modal fade" id="profileImageModal" tabindex="-1" role="dialog" aria-labelledby="profileImageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileImageModalLabel">
                    <i class="fa fa-camera me-2"></i>Update Student Photo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Browse Section -->
                <div id="browse-section" class="text-center">
                    <div class="image-upload-area" onclick="document.getElementById('uploadImage').click()">
                        <i class="fa fa-cloud-upload upload-icon"></i>
                        <h6>Choose an image to upload</h6>
                        <p class="text-muted mb-0">Click here or drag and drop your image</p>
                        <small class="text-muted">Supports JPG, PNG, GIF (Max: 5MB)</small>
                    </div>
                    <input type="file" id="uploadImage" accept="image/*" class="d-none">
                </div>
                
                <!-- Image Preview Section -->
                <div id="image-container" class="text-center mt-3" style="display: none;">
                    <img id="imagePreview" src="" alt="Image Preview" class="img-fluid">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa fa-times me-1"></i>Cancel
                </button>
                <button type="button" id="btnCrop" class="btn btn-primary" style="display: none;">
                    <i class="fas fa-crop me-1"></i>Crop Image
                </button>
                <button type="button" id="btnSave" class="btn btn-success" style="display: none;">
                    <i class="fas fa-save me-1"></i>Use This Photo
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeFormValidation();
    setupImageHandling();
    trackFormChanges();
    setupFieldEnhancements();
    setupConditionalFields();
    setupFormDebugging();
    addNavigationWarning();
});

// Enhanced form debugging
function setupFormDebugging() {
    const form = document.getElementById('student-update-form');
    
    // Add debug info to console
    console.log('Form initialized');
    console.log('Form method:', form.method);
    console.log('Form action:', form.action);
    console.log('Form enctype:', form.enctype);
    
    // Monitor form submission
    form.addEventListener('submit', function(e) {
        console.log('Form submission started');
        
        // Log form data
        const formData = new FormData(form);
        console.log('Form data:');
        for (let [key, value] of formData.entries()) {
            if (key !== 'csrfmiddlewaretoken') {
                console.log(`${key}: ${value}`);
            }
        }
        
        // Check for validation errors
        const invalidFields = form.querySelectorAll('.is-invalid');
        if (invalidFields.length > 0) {
            console.log('Invalid fields found:', invalidFields);
        }
    });
}

// Initialize form validation with better error handling - FIXED VERSION
function initializeFormValidation() {
    const form = document.getElementById('student-update-form');
    
    form.addEventListener('submit', function(e) {
        console.log('Form submit event triggered');
        
        const saveBtn = document.getElementById('save-btn');
        const saveSpinner = document.getElementById('save-spinner');
        const saveIcon = document.getElementById('save-icon');
        
        // Only prevent if there are actual validation errors
        const invalidFields = form.querySelectorAll(':invalid');
        if (invalidFields.length > 0) {
            e.preventDefault();
            console.log('Form validation failed');
            showFormValidationErrors();
            return false;
        }
        
        // Show loading state but don't prevent submission
        if (saveBtn) {
            saveBtn.disabled = true;
            if (saveSpinner) saveSpinner.style.display = 'inline-block';
            if (saveIcon) saveIcon.style.display = 'none';
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';
        }
        
        console.log('Form submission proceeding...');
        return true; // Allow form to submit normally
    });
    
    // Real-time validation
    const requiredFields = form.querySelectorAll('[required]');
    requiredFields.forEach(field => {
        field.addEventListener('blur', function() {
            validateField(this);
        });
        
        field.addEventListener('input', function() {
            if (this.classList.contains('is-invalid')) {
                validateField(this);
            }
        });
    });
    
    // Email validation
    const emailFields = form.querySelectorAll('input[type="email"]');
    emailFields.forEach(field => {
        field.addEventListener('blur', function() {
            validateEmailField(this);
        });
    });
    
    // Phone number formatting
    const phoneFields = form.querySelectorAll('input[name*="phone"]');
    phoneFields.forEach(field => {
        field.addEventListener('input', function() {
            formatPhoneNumber(this);
        });
    });
}

// Show form validation errors
function showFormValidationErrors() {
    const form = document.getElementById('student-update-form');
    const invalidFields = form.querySelectorAll(':invalid');
    
    if (invalidFields.length > 0) {
        // Just focus on the first invalid field
        invalidFields[0].focus();
        invalidFields[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Add visual indicators
        invalidFields.forEach(field => {
            field.classList.add('is-invalid');
        });
    }
}

// Setup conditional fields based on form values
function setupConditionalFields() {
    // Transportation fields visibility
    const transportRequired = document.querySelector('input[name="transportation_required"]');
    const transportDetails = document.getElementById('transport-details');
    
    if (transportRequired && transportDetails) {
        function toggleTransportFields() {
            const inputs = transportDetails.querySelectorAll('input');
            inputs.forEach(input => {
                input.disabled = !transportRequired.checked;
                if (!transportRequired.checked) {
                    input.classList.remove('is-invalid', 'is-valid');
                    input.value = '';
                }
            });
            transportDetails.classList.toggle('disabled-field', !transportRequired.checked);
        }
        
        transportRequired.addEventListener('change', toggleTransportFields);
        toggleTransportFields(); // Initial state
    }
    
    // Auto-sync admission academic level with current academic level if current is empty
    const admissionAcademicLevel = document.querySelector('select[name="admission_academic_level"]');
    const currentAcademicLevel = document.querySelector('select[name="current_academic_level"]');
    
    if (admissionAcademicLevel && currentAcademicLevel) {
        admissionAcademicLevel.addEventListener('change', function() {
            if (!currentAcademicLevel.value && this.value) {
                currentAcademicLevel.value = this.value;
                currentAcademicLevel.dispatchEvent(new Event('change'));
            }
        });
    }
    
    // Special needs conditional fields
    const hasSpecialNeeds = document.querySelector('input[name="has_special_needs"]');
    const specialNeedsDesc = document.querySelector('textarea[name="special_needs_description"]');
    
    if (hasSpecialNeeds && specialNeedsDesc) {
        function toggleSpecialNeedsDesc() {
            specialNeedsDesc.disabled = !hasSpecialNeeds.checked;
            if (!hasSpecialNeeds.checked) {
                specialNeedsDesc.value = '';
            }
            specialNeedsDesc.closest('.form-floating').classList.toggle('disabled-field', !hasSpecialNeeds.checked);
        }
        
        hasSpecialNeeds.addEventListener('change', toggleSpecialNeedsDesc);
        toggleSpecialNeedsDesc(); // Initial state
    }
    
    // Special diet conditional fields
    const requiresSpecialDiet = document.querySelector('input[name="requires_special_diet"]');
    const specialDietDetails = document.querySelector('textarea[name="special_diet_details"]');
    
    if (requiresSpecialDiet && specialDietDetails) {
        function toggleSpecialDietDetails() {
            specialDietDetails.disabled = !requiresSpecialDiet.checked;
            if (!requiresSpecialDiet.checked) {
                specialDietDetails.value = '';
            }
            specialDietDetails.closest('.form-floating').classList.toggle('disabled-field', !requiresSpecialDiet.checked);
        }
        
        requiresSpecialDiet.addEventListener('change', toggleSpecialDietDetails);
        toggleSpecialDietDetails(); // Initial state
    }
}

// Setup image handling with cropper
function setupImageHandling() {
    const uploadImageInput = document.getElementById("uploadImage");
    const imagePreview = document.getElementById("imagePreview");
    const btnCrop = document.getElementById("btnCrop");
    const btnSave = document.getElementById("btnSave");
    const browseSection = document.getElementById("browse-section");
    const imageContainer = document.getElementById("image-container");
    const profileImageModal = document.getElementById('profileImageModal');
    
    if (!profileImageModal) {
        console.error("Profile image modal not found!");
        return;
    }
    
    const modalInstance = new bootstrap.Modal(profileImageModal);
    
    // Variable to store cropper instance and cropped image data
    let cropper = null;
    let croppedImageData = null;

    // Function to show alerts
    function showAlert(type, message) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            <i class="fa fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insert at top of form
        const form = document.getElementById('student-update-form');
        form.insertAdjacentElement('afterbegin', alert);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }
    
    // Function to reset cropper and modal state
    function resetCropper() {
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        if (imagePreview) imagePreview.src = '';
        if (browseSection) browseSection.style.display = "block";
        if (imageContainer) imageContainer.style.display = "none";
        if (btnCrop) btnCrop.style.display = "none";
        if (btnSave) btnSave.style.display = "none";
        
        // Reset the file input
        if (uploadImageInput) {
            uploadImageInput.value = '';
        }
    }

    // Connect the overlay click handler with the modal
    const profileImageOverlay = document.querySelector('.profile-image-overlay');
    if (profileImageOverlay) {
        profileImageOverlay.addEventListener('click', function(e) {
            e.preventDefault();
            modalInstance.show();
        });
    }
    
    // Reset modal when it's hidden
    profileImageModal.addEventListener('hidden.bs.modal', function() {
        resetCropper();
    });

    // Handle file input change inside the modal
    if (uploadImageInput) {
        uploadImageInput.addEventListener("change", function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // File size validation
            if (file.size > 5 * 1024 * 1024) {
                showAlert('danger', 'File size must be less than 5MB.');
                return;
            }
            
            // File type validation
            if (!file.type.startsWith('image/')) {
                showAlert('danger', 'Please select a valid image file.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (browseSection) browseSection.style.display = "none";
                if (imageContainer) imageContainer.style.display = "block";
                if (imagePreview) imagePreview.src = e.target.result;
                
                // Initialize cropper
                if (cropper) {
                    cropper.destroy();
                }
                
                if (imagePreview) {
                    setTimeout(() => {
                        try {
                            cropper = new Cropper(imagePreview, {
                                aspectRatio: 1,
                                viewMode: 2,
                                dragMode: "move",
                                background: true,
                                responsive: true,
                                autoCropArea: 0.8,
                                ready: function() {
                                    if (btnCrop) btnCrop.style.display = "inline-block";
                                }
                            });
                        } catch (err) {
                            console.error("Cropper initialization error:", err);
                            showAlert('danger', 'Error initializing image cropper. Please try again.');
                        }
                    }, 200);
                }
            };
            reader.readAsDataURL(file);
        });
    }

    // Handle Image cropping
    if (btnCrop) {
        btnCrop.addEventListener("click", function() {
            if (!cropper) return;
            
            try {
                const canvas = cropper.getCroppedCanvas({
                    width: 300,
                    height: 300,
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high',
                });
                
                croppedImageData = canvas.toDataURL("image/jpeg", 0.9);
                if (imagePreview) imagePreview.src = croppedImageData;
                
                // Destroy cropper after cropping
                cropper.destroy();
                cropper = null;
                
                // Show save button, hide crop button
                if (btnCrop) btnCrop.style.display = "none";
                if (btnSave) btnSave.style.display = "inline-block";
            } catch (err) {
                console.error("Cropping error:", err);
                showAlert('danger', 'Error cropping image. Please try again.');
            }
        });
    }

    // Save the cropped image
    if (btnSave) {
        btnSave.addEventListener("click", function() {
            if (!croppedImageData) return;

            // Show loading state
            btnSave.disabled = true;
            btnSave.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i> Saving...';

            try {
                // Convert base64 to blob
                const blobBin = atob(croppedImageData.split(',')[1]);
                const array = [];
                for(let i = 0; i < blobBin.length; i++) {
                    array.push(blobBin.charCodeAt(i));
                }
                const file = new Blob([new Uint8Array(array)], {type: 'image/jpeg'});

                // Create a File object and set it to the hidden input
                const dt = new DataTransfer();
                dt.items.add(new File([file], 'profile.jpg', {type: 'image/jpeg'}));
                
                const hiddenFileInput = document.querySelector('input[name="photo"]');
                if (hiddenFileInput) {
                    hiddenFileInput.files = dt.files;
                }

                // Update the profile image preview on the page
                const currentProfileImage = document.getElementById("currentProfileImage");
                if (currentProfileImage) {
                    currentProfileImage.src = croppedImageData;
                } else {
                    // If there was no image before (using avatar placeholder), replace with new image
                    const placeholder = document.querySelector('.avatar-placeholder');
                    if (placeholder) {
                        const container = placeholder.parentElement;
                        container.innerHTML = `
                            <img id="currentProfileImage" src="${croppedImageData}" alt="Profile Picture" class="profile-avatar">
                            <div class="profile-image-overlay">
                                <i class="fas fa-camera"></i>
                            </div>
                        `;
                        
                        // Re-attach click handler
                        const newOverlay = container.querySelector('.profile-image-overlay');
                        if (newOverlay) {
                            newOverlay.addEventListener('click', function(e) {
                                e.preventDefault();
                                modalInstance.show();
                            });
                        }
                    }
                }
                
                // Show success message
                showAlert('success', 'Student photo updated! Remember to save the form to apply changes.');
                
                // Close modal
                modalInstance.hide();
            } catch (err) {
                console.error("Error preparing image:", err);
                showAlert('danger', 'Error preparing image. Please try again.');
            } finally {
                // Reset button state
                btnSave.disabled = false;
                btnSave.innerHTML = '<i class="fas fa-save me-1"></i>Use This Photo';
            }
        });
    }
    
    // Drag and drop functionality
    const uploadArea = document.querySelector('.image-upload-area');
    if (uploadArea) {
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                uploadImageInput.files = files;
                uploadImageInput.dispatchEvent(new Event('change'));
            }
        });
    }
}

// FIXED: Simpler change tracking without beforeunload
let hasUnsavedChanges = false;

function trackFormChanges() {
    const form = document.getElementById('student-update-form');
    const formFields = form.querySelectorAll('input, select, textarea');
    
    formFields.forEach(field => {
        field.addEventListener('change', function() {
            hasUnsavedChanges = true;
            // Visual indicator
            if (this.type === 'checkbox') {
                this.parentElement.classList.add('border-warning');
            } else {
                this.classList.add('border-warning');
            }
        });
    });
    
    // Clear changes flag on successful submit
    form.addEventListener('submit', function() {
        hasUnsavedChanges = false;
    });
}

// Optional: Add a manual warning only for navigation buttons
function addNavigationWarning() {
    const navigationLinks = document.querySelectorAll('a[href*="student"]');
    navigationLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            if (hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Are you sure you want to leave?')) {
                    e.preventDefault();
                }
            }
        });
    });
}

// Setup field enhancements
function setupFieldEnhancements() {
    // Capitalize names automatically
    const nameFields = document.querySelectorAll('input[name*="name"]:not([name*="user"])');
    nameFields.forEach(field => {
        field.addEventListener('input', function() {
            capitalizeField(this);
        });
    });
    
    // Format ID numbers
    const idFields = document.querySelectorAll('input[name*="national_"], input[name*="birth_certificate_"]');
    idFields.forEach(field => {
        field.addEventListener('input', function() {
            this.value = this.value.replace(/[^A-Z0-9]/gi, '').toUpperCase();
        });
    });
    
    // Date validation
    const dateFields = document.querySelectorAll('input[type="date"]');
    dateFields.forEach(field => {
        field.addEventListener('change', function() {
            validateDateField(this);
        });
    });
    
    // Age calculation display
    const dobField = document.querySelector('input[name="date_of_birth"]');
    if (dobField) {
        dobField.addEventListener('change', function() {
            updateAgeDisplay(this.value);
        });
        
        // Calculate age on page load if date exists
        if (dobField.value) {
            updateAgeDisplay(dobField.value);
        }
    }
}

// Update age display when date of birth changes
function updateAgeDisplay(dateOfBirth) {
    if (!dateOfBirth) return;
    
    const today = new Date();
    const dob = new Date(dateOfBirth);
    let age = today.getFullYear() - dob.getFullYear();
    const monthDiff = today.getMonth() - dob.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
        age--;
    }
    
    // Find or create age display element
    let ageDisplay = document.getElementById('age-display');
    if (!ageDisplay) {
        ageDisplay = document.createElement('div');
        ageDisplay.id = 'age-display';
        ageDisplay.className = 'form-text';
        
        const dobContainer = document.querySelector('input[name="date_of_birth"]').closest('.form-floating');
        dobContainer.appendChild(ageDisplay);
    }
    
    ageDisplay.textContent = `Age: ${age} years`;
    
    // Validate age
    if (age < 2 || age > 35) {
        ageDisplay.className = 'form-text text-danger';
        ageDisplay.textContent += ' (Age seems unusual for a student)';
    } else {
        ageDisplay.className = 'form-text text-muted';
    }
}

// Validate individual field
function validateField(field) {
    field.classList.remove('is-invalid', 'is-valid');
    
    if (field.hasAttribute('required') && !field.value.trim()) {
        field.classList.add('is-invalid');
        return false;
    }
    
    if (field.type === 'email' && field.value && !isValidEmail(field.value)) {
        field.classList.add('is-invalid');
        return false;
    }
    
    if (field.value.trim()) {
        field.classList.add('is-valid');
    }
    
    return true;
}

// Validate email field
function validateEmailField(field) {
    field.classList.remove('is-invalid', 'is-valid');
    
    if (field.value && !isValidEmail(field.value)) {
        field.classList.add('is-invalid');
        return false;
    }
    
    if (field.value) {
        field.classList.add('is-valid');
    }
    
    return true;
}

// Validate date field
function validateDateField(field) {
    field.classList.remove('is-invalid', 'is-valid');
    
    if (field.value) {
        const date = new Date(field.value);
        const today = new Date();
        
        if (field.name === 'date_of_birth') {
            if (date > today) {
                field.classList.add('is-invalid');
                return false;
            }
            const age = (today - date) / (365.25 * 24 * 60 * 60 * 1000);
            if (age < 2 || age > 35) {
                field.classList.add('is-invalid');
                return false;
            }
        }
        
        if (field.name === 'admission_date' && date > today) {
            field.classList.add('is-invalid');
            return false;
        }
        
        // Validate that previous school completion date is in the past
        if (field.name === 'previous_school_completion_date' && date > today) {
            field.classList.add('is-invalid');
            return false;
        }
        
        field.classList.add('is-valid');
    }
    
    return true;
}

// Helper validation functions
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function formatPhoneNumber(field) {
    let value = field.value.replace(/[^\d+]/g, '');
    
    // Auto-format Ugandan numbers
    if (value.startsWith('0') && value.length === 10) {
        value = '+256' + value.substring(1);
    } else if (value.startsWith('256') && value.length === 12) {
        value = '+' + value;
    } else if (value.startsWith('7') && value.length === 9) {
        value = '+256' + value;
    }
    
    field.value = value;
}

function capitalizeField(field) {
    const words = field.value.split(' ');
    const capitalizedWords = words.map(word => {
        if (word.length > 0) {
            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        }
        return word;
    });
    field.value = capitalizedWords.join(' ');
}

function getFieldLabel(field) {
    const label = document.querySelector(`label[for="${field.id}"]`);
    return label ? label.textContent.replace('*', '').trim() : field.name;
}

// Show validation errors
function showValidationErrors(errors) {
    const errorHtml = `
        <div class="alert alert-danger alert-dismissible fade show">
            <h6><i class="fa fa-exclamation-triangle me-2"></i>Please correct the following errors:</h6>
            <ul class="mb-0">
                ${errors.map(error => `<li>${error}</li>`).join('')}
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Remove existing error alerts
    const existingAlerts = document.querySelectorAll('.alert-danger');
    existingAlerts.forEach(alert => alert.remove());
    
    // Insert at top of form
    const form = document.getElementById('student-update-form');
    form.insertAdjacentHTML('afterbegin', errorHtml);
    
    // Scroll to top
    form.scrollIntoView({ behavior: 'smooth' });
}

// Reset form to original values
function resetForm() {
    if (confirm('Are you sure you want to reset all changes? This will restore the original values.')) {
        location.reload();
    }
}

// Enhanced field relationships
document.addEventListener('DOMContentLoaded', function() {
    // Handle previous school dependencies
    const previousSchoolField = document.querySelector('input[name="previous_school"]');
    const previousSchoolDependentFields = [
        'previous_academic_level',
        'previous_school_address',
        'transfer_certificate_number',
        'previous_school_completion_date',
        'transfer_reason'
    ];
    
    if (previousSchoolField) {
        function togglePreviousSchoolFields() {
            const hasValue = previousSchoolField.value.trim() !== '';
            
            previousSchoolDependentFields.forEach(fieldName => {
                const field = document.querySelector(`[name="${fieldName}"]`);
                if (field) {
                    const container = field.closest('.form-floating');
                    if (hasValue) {
                        container.classList.remove('disabled-field');
                        field.disabled = false;
                    } else {
                        container.classList.add('disabled-field');
                        field.disabled = true;
                        if (field.type !== 'checkbox') {
                            field.value = '';
                        }
                    }
                }
            });
        }
        
        previousSchoolField.addEventListener('input', togglePreviousSchoolFields);
        previousSchoolField.addEventListener('change', togglePreviousSchoolFields);
        togglePreviousSchoolFields(); // Initial state
    }
});

// Form error monitoring
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('student-update-form');
    
    // Monitor for server-side validation errors
    const serverErrors = document.querySelectorAll('.invalid-feedback');
    if (serverErrors.length > 0) {
        console.log('Server validation errors found:', serverErrors.length);
        
        // Scroll to first error
        const firstError = serverErrors[0];
        const field = firstError.closest('.form-floating') || firstError.closest('.form-check');
        if (field) {
            field.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
});

console.log('Student Form JavaScript loaded successfully');
</script>

{% endblock %}