{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
  <!-- CSS for CropperJS, SweetAlert2, MagnifiPopup -->
  <link href="{% static 'vendor/cropperjs/dist/cropper.min.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/sweetalert2/dist/sweetalert2.min.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/magnific-popup/magnific-popup.css' %}" rel="stylesheet">

    <style>
        /* Profile Image Styling */
        .profile-image-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
        }

        .profile-image-container .profile-avatar {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 50%;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            border: 3px solid #fff;
        }

        .avatar-placeholder {
            width: 120px;
            height: 120px;
            background-color: #f8f9fa;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid #fff;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .avatar-title {
            font-size: 48px;
            color: #556ee6;
            font-weight: 500;
        }

        .profile-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: pointer;
        }

        .profile-image-container:hover .profile-image-overlay {
            opacity: 1;
        }

        .profile-image-overlay i {
            color: white;
            font-size: 24px;
        }

        /* Image Cropper Modal Styling */
        #image-container {
            max-width: 100%;
            margin: 0 auto;
        }

        #imagePreview {
            max-width: 100%;
            max-height: 400px;
            display: block;
            margin: 0 auto;
        }

        .cropper-container {
            margin: 0 auto;
        }

        .image-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .image-upload-area:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }

        .image-upload-area.dragover {
            border-color: #667eea;
            background-color: #f0f2ff;
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .info-section {
            margin-bottom: 2rem;
        }

        .info-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .info-row {
            display: flex;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #6c757d;
            min-width: 200px;
            flex-shrink: 0;
        }

        .info-value {
            color: #212529;
            flex-grow: 1;
        }

        .info-value code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .empty-value {
            color: #adb5bd;
            font-style: italic;
        }

        .section-icon {
            margin-right: 0.5rem;
            color: #556ee6;
        }
    </style>

{% endblock %}

{% block content %}

<div class="app-page-title">
    <div class="page-title-wrapper">
        <div class="page-title-heading">
            <div class="page-title-icon">
                <i class="pe-7s-study icon-gradient bg-happy-itmeo"></i>
            </div>
            <div>
                    Student Profile
                <div class="page-title-subheading">
                    Complete student information and details
                </div>
            </div>
        </div>
        <div class="page-title-actions">
            <div class="dropdown">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fa fa-ellipsis-v me-1"></i> Actions
                </button>
                <div class="dropdown-menu dropdown-menu-end">
                    <a class="dropdown-item" href="#">
                         <i class="fa fa-users me-2"></i> Manage Guardians
                    </a>
                    <a class="dropdown-item" href="#">
                        <i class="fa fa-ruler me-2"></i> Measurements
                    </a>
                    <a class="dropdown-item" href="#">
                        <i class="fa fa-file-alt me-2"></i> Documents
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="{% url 'students:student_list' %}">
                        <i class="fa fa-list me-2"></i> Back to Student List
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% if messages %}
    {% for message in messages %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-1"></i>
        {{ message}}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
{% endif %}

<section class="section profile">
    <div class="row">
        <div class="col-xl-4">
            <div class="card">
                <div class="card-body profile-card pt-4 d-flex flex-column align-items-center">
                    {% if student.photo %}
                        <img id="currentProfileImage" src="{{ student.photo.url }}" alt="{{ student.get_full_name }}" class="profile-avatar me-2">
                    {% else %}
                        <div class="avatar-placeholder me-2">
                            <div class="avatar-title">
                                {% if student.first_name %}{{ student.first_name|first }}{% endif %}{% if student.last_name %}{{ student.last_name|first }}{% endif %}
                            </div>
                        </div>
                    {% endif %}

                    <div class="mt-3">
                        <a href="#" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#profileImageModal">
                            <i class="bi bi-image"></i> Change Photo
                        </a>
                    </div>
                    <h2 class="mt-3">{{ student.get_full_name }}</h2>

                    <div class="mt-3">
                        {% if student.enrollment_status == 'active' %}
                            <span class="badge bg-success">{{ student.get_enrollment_status_display }}</span>
                        {% elif student.enrollment_status == 'graduated' %}
                            <span class="badge bg-warning text-dark">{{ student.get_enrollment_status_display }}</span>
                        {% elif student.enrollment_status == 'dismissed' %}
                            <span class="badge bg-danger">{{ student.get_enrollment_status_display }}</span>
                        {% elif student.enrollment_status == 'transferred' %}
                            <span class="badge bg-secondary">{{ student.get_enrollment_status_display }}</span>
                        {% elif student.enrollment_status == 'suspended' %}
                            <span class="badge bg-danger">{{ student.get_enrollment_status_display }}</span>
                        {% elif student.enrollment_status == 'withdrawn' %}
                            <span class="badge bg-secondary">{{ student.get_enrollment_status_display }}</span>
                        {% else %}
                            <span class="badge bg-info">{{ student.get_enrollment_status_display }}</span>
                        {% endif %}
                    </div>

                    <div class="mt-4 d-flex gap-2">
                        <a href="{% url 'students:student_edit' student.pk %}" class="btn btn-sm btn-warning me-1">
                            <i class="bi bi-pencil"></i> Edit
                        </a>
                        <a href="#" class="btn btn-sm btn-danger me-1" data-bs-toggle="modal" data-bs-target="#deleteStudent{{ student.pk }}">
                            <i class="bi bi-trash"></i> Delete
                        </a>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Quick Stats</h5>
                    <div class="d-flex flex-column gap-3">
                        <div class="d-flex justify-content-between">
                            <span><i class="bi bi-calendar-event text-primary"></i> Age:</span>
                            <strong>{{ student.get_age }} years</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="bi bi-gender-ambiguous text-primary"></i> Gender:</span>
                            <strong>{{ student.get_gender_display }}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="bi bi-book text-primary"></i> Level:</span>
                            <strong>{{ student.current_academic_level|default:"N/A" }}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="bi bi-person-check text-primary"></i> Status:</span>
                            <strong>{{ student.get_enrollment_status_display }}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="bi bi-droplet text-danger"></i> Blood Type:</span>
                            <strong>{{ student.get_blood_type_display }}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="bi bi-flag text-success"></i> Nationality:</span>
                            <strong>{{ student.nationality.name|default:"N/A" }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-8">
            <div class="mb-3 card">
                <div class="card-header card-header-tab-animation">
                    <ul class="nav nav-justified">
                        <li class="nav-item">
                            <a data-bs-toggle="tab" href="#tab-personal" class="active nav-link">Personal Info</a>
                        </li>
                        <li class="nav-item">
                            <a data-bs-toggle="tab" href="#tab-academic" class="nav-link">Academic</a>
                        </li>
                        <li class="nav-item">
                            <a data-bs-toggle="tab" href="#tab-contact" class="nav-link">Contact</a>
                        </li>
                        <li class="nav-item">
                            <a data-bs-toggle="tab" href="#tab-health" class="nav-link">Health</a>
                        </li>
                        <li class="nav-item">
                            <a data-bs-toggle="tab" href="#tab-other" class="nav-link">Other</a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Personal Information Tab -->
                        <div class="tab-pane active" id="tab-personal" role="tabpanel">
                            <div class="info-section">
                                <h5 class="info-section-title">
                                    <i class="bi bi-person-badge section-icon"></i>Identification
                                </h5>
                                <div class="info-row">
                                    <div class="info-label">Admission Number</div>
                                    <div class="info-value"><code>{{ student.admission_number }}</code></div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">National Student Number</div>
                                    <div class="info-value">{{ student.national_student_number|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Birth Certificate Number</div>
                                    <div class="info-value">{{ student.birth_certificate_number|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                            </div>

                            <div class="info-section">
                                <h5 class="info-section-title">
                                    <i class="bi bi-person section-icon"></i>Basic Information
                                </h5>
                                <div class="info-row">
                                    <div class="info-label">Full Name</div>
                                    <div class="info-value">{{ student.get_full_name }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">First Name</div>
                                    <div class="info-value">{{ student.first_name }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Middle Name</div>
                                    <div class="info-value">{{ student.middle_name|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Last Name</div>
                                    <div class="info-value">{{ student.last_name }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Gender</div>
                                    <div class="info-value">{{ student.get_gender_display }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Date of Birth</div>
                                    <div class="info-value">{{ student.date_of_birth|date:"F d, Y" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Age</div>
                                    <div class="info-value">{{ student.get_age }} years</div>
                                </div>
                            </div>

                            <div class="info-section">
                                <h5 class="info-section-title">
                                    <i class="bi bi-globe section-icon"></i>Demographics & Cultural
                                </h5>
                                <div class="info-row">
                                    <div class="info-label">Nationality</div>
                                    <div class="info-value">{{ student.nationality.name|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Ethnicity</div>
                                    <div class="info-value">{{ student.ethnicity|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Place of Birth</div>
                                    <div class="info-value">{{ student.birth_place|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Country of Birth</div>
                                    <div class="info-value">{{ student.birth_country.name|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Religious Affiliation</div>
                                    <div class="info-value">{{ student.get_religious_affiliation_display|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Academic Information Tab -->
                        <div class="tab-pane" id="tab-academic" role="tabpanel">
                            <div class="info-section">
                                <h5 class="info-section-title">
                                    <i class="bi bi-book section-icon"></i>Current Academic Status
                                </h5>
                                <div class="info-row">
                                    <div class="info-label">Current Academic Level</div>
                                    <div class="info-value">{{ student.current_academic_level|default:"<span class='empty-value'>Not assigned</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Admission Academic Level</div>
                                    <div class="info-value">{{ student.admission_academic_level|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Enrollment Status</div>
                                    <div class="info-value">
                                        {% if student.enrollment_status == 'active' %}
                                            <span class="badge bg-success">{{ student.get_enrollment_status_display }}</span>
                                        {% elif student.enrollment_status == 'graduated' %}
                                            <span class="badge bg-warning text-dark">{{ student.get_enrollment_status_display }}</span>
                                        {% elif student.enrollment_status == 'dismissed' or student.enrollment_status == 'suspended' %}
                                            <span class="badge bg-danger">{{ student.get_enrollment_status_display }}</span>
                                        {% elif student.enrollment_status == 'transferred' or student.enrollment_status == 'withdrawn' %}
                                            <span class="badge bg-secondary">{{ student.get_enrollment_status_display }}</span>
                                        {% else %}
                                            <span class="badge bg-info">{{ student.get_enrollment_status_display }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Admission Date</div>
                                    <div class="info-value">{{ student.admission_date|date:"F d, Y" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Graduation Date</div>
                                    <div class="info-value">{{ student.graduation_date|date:"F d, Y"|default:"<span class='empty-value'>Not graduated yet</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Withdrawal Date</div>
                                    <div class="info-value">{{ student.withdrawal_date|date:"F d, Y"|default:"<span class='empty-value'>N/A</span>" }}</div>
                                </div>
                            </div>

                            <div class="info-section">
                                <h5 class="info-section-title">
                                    <i class="bi bi-building section-icon"></i>Previous Education
                                </h5>
                                <div class="info-row">
                                    <div class="info-label">Previous School</div>
                                    <div class="info-value">{{ student.previous_school|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Previous School Address</div>
                                    <div class="info-value">{{ student.previous_school_address|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Previous Academic Level</div>
                                    <div class="info-value">{{ student.previous_academic_level|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Transfer Reason</div>
                                    <div class="info-value">{{ student.transfer_reason|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Transfer Certificate Number</div>
                                    <div class="info-value">{{ student.transfer_certificate_number|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Previous School Completion Date</div>
                                    <div class="info-value">{{ student.previous_school_completion_date|date:"F d, Y"|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information Tab -->
                        <div class="tab-pane" id="tab-contact" role="tabpanel">
                            <div class="info-section">
                                <h5 class="info-section-title">
                                    <i class="bi bi-telephone section-icon"></i>Contact Details
                                </h5>
                                <div class="info-row">
                                    <div class="info-label">Personal Email</div>
                                    <div class="info-value">{{ student.personal_email|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Phone Number</div>
                                    <div class="info-value">{{ student.phone_number|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                            </div>

                            <div class="info-section">
                                <h5 class="info-section-title">
                                    <i class="bi bi-house section-icon"></i>Address Information
                                </h5>
                                <div class="info-row">
                                    <div class="info-label">Home Address</div>
                                    <div class="info-value">{{ student.home_address|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Mailing Address</div>
                                    <div class="info-value">{{ student.mailing_address|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">District</div>
                                    <div class="info-value">{{ student.district|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Region/Province</div>
                                    <div class="info-value">{{ student.region|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Country of Residence</div>
                                    <div class="info-value">{{ student.country_of_residence.name|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                            </div>

                            <div class="info-section">
                                <h5 class="info-section-title">
                                    <i class="bi bi-people section-icon"></i>Guardian Information
                                </h5>
                                {% if student.guardians.all %}
                                    {% for guardian in student.guardians.all %}
                                    <div class="alert alert-light border mb-2">
                                        <strong>{{ guardian.get_full_name }}</strong><br>
                                        <small class="text-muted">{{ guardian.relationship|default:"Guardian" }}</small>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="info-row">
                                        <div class="info-value"><span class="empty-value">No guardians assigned</span></div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Health Information Tab -->
                        <div class="tab-pane" id="tab-health" role="tabpanel">
                            <div class="info-section">
                                <h5 class="info-section-title">
                                    <i class="bi bi-heart-pulse section-icon"></i>General Health
                                </h5>
                                <div class="info-row">
                                    <div class="info-label">Health Condition</div>
                                    <div class="info-value">{{ student.get_health_condition_display }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Blood Type</div>
                                    <div class="info-value">{{ student.get_blood_type_display }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Medical Conditions</div>
                                    <div class="info-value">{{ student.medical_conditions|default:"<span class='empty-value'>None reported</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Allergies</div>
                                    <div class="info-value">{{ student.allergies|default:"<span class='empty-value'>None reported</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Current Medications</div>
                                    <div class="info-value">{{ student.medications|default:"<span class='empty-value'>None</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Special Medical Needs</div>
                                    <div class="info-value">{{ student.special_medical_needs|default:"<span class='empty-value'>None</span>" }}</div>
                                </div>
                            </div>

                            <div class="info-section">
                                <h5 class="info-section-title">
                                    <i class="bi bi-hospital section-icon"></i>Emergency & Insurance
                                </h5>
                                <div class="info-row">
                                    <div class="info-label">Emergency Medical Contact</div>
                                    <div class="info-value">{{ student.emergency_medical_contact|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Preferred Hospital</div>
                                    <div class="info-value">{{ student.preferred_hospital|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Medical Insurance</div>
                                    <div class="info-value">{{ student.medical_insurance|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Insurance Policy Number</div>
                                    <div class="info-value">{{ student.insurance_policy_number|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                            </div>

                            <div class="info-section">
                                <h5 class="info-section-title">
                                    <i class="bi bi-wheelchair section-icon"></i>Special Needs
                                </h5>
                                <div class="info-row">
                                    <div class="info-label">Has Special Needs</div>
                                    <div class="info-value">
                                        {% if student.has_special_needs %}
                                            <span class="badge bg-warning">Yes</span>
                                        {% else %}
                                            <span class="badge bg-success">No</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if student.has_special_needs %}
                                <div class="info-row">
                                    <div class="info-label">Special Needs Description</div>
                                    <div class="info-value">{{ student.special_needs_description|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                {% endif %}
                                <div class="info-row">
                                    <div class="info-label">Requires Special Diet</div>
                                    <div class="info-value">
                                        {% if student.requires_special_diet %}
                                            <span class="badge bg-warning">Yes</span>
                                        {% else %}
                                            <span class="badge bg-success">No</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if student.requires_special_diet %}
                                <div class="info-row">
                                    <div class="info-label">Special Diet Details</div>
                                    <div class="info-value">{{ student.special_diet_details|default:"<span class='empty-value'>Not provided</span>" }}</div>
                                </div>
                                {% endif %}
                                <div class="info-row">
                                    <div class="info-label">Learning Disabilities</div>
                                    <div class="info-value">{{ student.learning_disabilities|default:"<span class='empty-value'>None reported</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Learning Accommodations</div>
                                    <div class="info-value">{{ student.learning_accommodations|default:"<span class='empty-value'>None required</span>" }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Other Information Tab -->
                        <div class="tab-pane" id="tab-other" role="tabpanel">
                            <div class="info-section">
                                <h5 class="info-section-title">
                                    <i class="bi bi-bus-front section-icon"></i>Transportation
                                </h5>
                                <div class="info-row">
                                    <div class="info-label">Transportation Required</div>
                                    <div class="info-value">
                                        {% if student.transportation_required %}
                                            <span class="badge bg-success">Yes</span>
                                        {% else %}
                                            <span class="badge bg-secondary">No</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if student.transportation_required %}
                                <div class="info-row">
                                    <div class="info-label">Transport Route</div>
                                    <div class="info-value">{{ student.transport_route|default:"<span class='empty-value'>Not assigned</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Pickup Point</div>
                                    <div class="info-value">{{ student.pickup_point|default:"<span class='empty-value'>Not assigned</span>" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Pickup Time</div>
                                    <div class="info-value">{{ student.pickup_time|time:"g:i A"|default:"<span class='empty-value'>Not assigned</span>" }}</div>
                                </div>
                                {% endif %}
                            </div>

                            <div class="info-section">
                                <h5 class="info-section-title">
                                    <i class="bi bi-clock-history section-icon"></i>Activity Log
                                </h5>
                                <div class="activity">
                                    <div class="activity-item d-flex align-items-start mb-3 pb-3 border-bottom">
                                        <div class="activity-icon me-3">
                                            <i class="bi bi-check-circle-fill text-success fs-5"></i>
                                        </div>
                                        <div class="activity-details flex-grow-1">
                                            <div class="d-flex justify-content-between">
                                                <span class="fw-semibold">Profile Updated</span>
                                                <span class="text-muted small">{{ student.updated_at|timesince }} ago</span>
                                            </div>
                                            <div class="text-muted small">The student information was last modified on {{ student.updated_at|date:"F d, Y \a\t g:i A" }}</div>
                                        </div>
                                    </div>

                                    <div class="activity-item d-flex align-items-start mb-3">
                                        <div class="activity-icon me-3">
                                            <i class="bi bi-person-plus-fill text-primary fs-5"></i>
                                        </div>
                                        <div class="activity-details flex-grow-1">
                                            <div class="d-flex justify-content-between">
                                                <span class="fw-semibold">Student Enrolled</span>
                                                <span class="text-muted small">{{ student.created_at|timesince }} ago</span>
                                            </div>
                                            <div class="text-muted small">Initial profile was created on {{ student.created_at|date:"F d, Y \a\t g:i A" }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="info-section">
                                <h5 class="info-section-title">
                                    <i class="bi bi-info-circle section-icon"></i>System Information
                                </h5>
                                <div class="info-row">
                                    <div class="info-label">Created At</div>
                                    <div class="info-value">{{ student.created_at|date:"F d, Y \a\t g:i A" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Last Updated</div>
                                    <div class="info-value">{{ student.updated_at|date:"F d, Y \a\t g:i A" }}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Record ID</div>
                                    <div class="info-value"><code>{{ student.pk }}</code></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>

<!-- Delete Modal -->
<div class="modal fade" tabindex="-1" id="deleteStudent{{ student.pk }}">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Student</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
            <i class="bi bi-exclamation-triangle-fill text-warning fs-1"></i>
            <h5 class="mt-3">Are you sure?</h5>
            <p class="text-muted">You are about to delete <strong>{{ student.get_full_name }}</strong>. This action cannot be undone.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form action="{% url 'students:student_delete' student.pk %}" method="post" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">
                <i class="bi bi-trash me-1"></i>Delete Student
            </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Profile Image Modal -->
<div class="modal fade" id="profileImageModal" tabindex="-1" role="dialog" aria-labelledby="profileImageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileImageModalLabel">
                    <i class="fa fa-camera me-2"></i>Update Student Photo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Browse Section -->
                <div id="browse-section" class="text-center">
                    <div class="image-upload-area" onclick="document.getElementById('uploadImage').click()">
                        <i class="fa fa-cloud-upload upload-icon"></i>
                        <h6>Choose an image to upload</h6>
                        <p class="text-muted mb-0">Click here or drag and drop your image</p>
                        <small class="text-muted">Supports JPG, PNG, GIF (Max: 5MB)</small>
                    </div>
                    <input type="file" id="uploadImage" accept="image/*" class="d-none">
                </div>
                
                <!-- Image Preview Section -->
                <div id="image-container" class="text-center mt-3" style="display: none;">
                    <img id="imagePreview" src="" alt="Image Preview" class="img-fluid">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa fa-times me-1"></i>Cancel
                </button>
                <button type="button" id="btnCrop" class="btn btn-primary" style="display: none;">
                    <i class="fas fa-crop me-1"></i>Crop Image
                </button>
                <button type="button" id="btnSave" class="btn btn-success" style="display: none;">
                    <i class="fas fa-save me-1"></i>Use This Photo
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="{% static 'vendor/cropperjs/dist/cropper.min.js' %}"></script>
<script src="{% static 'vendor/sweetalert2/dist/sweetalert2.all.min.js' %}"></script>
<script src="{% static 'vendor/magnific-popup/jquery.magnific-popup.min.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadImage = document.querySelector("#uploadImage"),
          imagePreview = document.querySelector("#imagePreview"),
          btnCrop = document.querySelector("#btnCrop"),
          btnSave = document.querySelector("#btnSave"),
          browseSection = document.querySelector("#browse-section"),
          imageContainer = document.querySelector("#image-container");

    const updateProfilePictureUrl = "{% url 'students:ajax_update_student_profile_picture' %}";
    const studentId = "{{ student.id }}";

    let cropper = null;
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Handle image selection
    if (uploadImage) {
        uploadImage.addEventListener("change", (evt) => {
            const file = evt.target.files[0];
            if (!file) return;

            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
            if (!allowedTypes.includes(file.type)) {
                Swal.fire({
                    title: 'Invalid File Type!',
                    text: 'Please select a JPG or PNG image.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
                uploadImage.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const originalImage = e.target.result;
                browseSection.style.display = "none";
                imageContainer.style.display = "block";
                imagePreview.src = originalImage;

                // Destroy old cropper if exists
                if (cropper) cropper.destroy();

                // Initialize cropper immediately after image loads
                cropper = new Cropper(imagePreview, {
                    aspectRatio: 1,
                    viewMode: 2,
                    dragMode: "move",
                    background: true,
                    responsive: true,
                    ready() {
                        btnCrop.style.display = "inline-block";
                    }
                });
            };
            reader.readAsDataURL(file);
        });
    }

    // Handle cropping
    btnCrop.addEventListener("click", () => {
        if (!cropper) return;

        const canvas = cropper.getCroppedCanvas({ width: 350, height: 350 });
        imagePreview.src = canvas.toDataURL("image/jpeg", 1.0);

        cropper.destroy();
        cropper = null;

        btnCrop.style.display = "none";
        btnSave.style.display = "inline-block";
    });

    // Handle save
    btnSave.addEventListener("click", () => {
        if (!imagePreview.src) {
            Swal.fire({
                title: 'Error!',
                text: 'No image to save!',
                icon: 'error',
            });
            return;
        }

        Swal.fire({
            title: 'Uploading...',
            text: 'Please wait while we save your profile picture',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading()
        });

        fetch(updateProfilePictureUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken,
            },
            body: JSON.stringify({
                student_id: studentId,
                image: imagePreview.src
            }),
        })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new TypeError("Server didn't return JSON. Please try again");
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                Swal.fire({
                    title: 'Success',
                    text: data.message,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = data.redirect_url;
                });
            } else {
                Swal.fire({ 
                    title: 'Error!', 
                    text: data.message || 'Failed to update profile picture.', 
                    icon: 'error' 
                });
            }
        })
        .catch(error => {
            console.error("Error:", error);
            Swal.fire({ 
                title: 'Error!', 
                text: error.message || 'An unexpected error occurred.', 
                icon: 'error' 
            });
        });
    });

    // Optional: Magnific Popup
    if (window.jQuery && $('.image-popup-no-margins').length) {
        $('.image-popup-no-margins').magnificPopup({
            type: 'image',
            closeOnContentClick: true,
            closeBtnInside: false,
            fixedContentPos: true,
            mainClass: 'mfp-no-margins mfp-with-zoom',
            image: { verticalFit: true },
            zoom: { enabled: true, duration: 300 }
        });
    }

});
</script>
{% endblock %}