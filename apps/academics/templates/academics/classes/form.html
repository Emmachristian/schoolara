{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<style>
    .form-container {
        background: #fff;
        border-radius: 0.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(33, 40, 50, 0.15);
    }
    
    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #495057;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.5rem;
    }
    
    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .required-field::after {
        content: ' *';
        color: #dc3545;
        font-weight: bold;
    }
    
    .form-control:focus {
        border-color: #556ee6;
        box-shadow: 0 0 0 0.25rem rgba(85, 110, 230, 0.25);
    }
    
    .form-check-input:checked {
        background-color: #556ee6;
        border-color: #556ee6;
    }
    
    .info-card {
        border: 1px solid #e9ecef;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: #f8f9fa;
    }
    
    .info-card.selected {
        background-color: #e8f0ff;
        border-color: #556ee6;
    }
    
    .btn-primary {
        background-color: #556ee6;
        border-color: #556ee6;
    }
    
    .btn-primary:hover {
        background-color: #4458ca;
        border-color: #4458ca;
    }
    
    .help-text {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .invalid-feedback {
        display: block;
    }
    
    .breadcrumb-item + .breadcrumb-item::before {
        content: '>';
        color: #6c757d;
    }
    
    .back-button {
        transition: all 0.3s ease;
    }
    
    .back-button:hover {
        transform: translateX(-3px);
    }
    
    .level-preview {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-top: 0.5rem;
        display: none;
    }
    
    .teacher-preview {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-top: 0.5rem;
        display: none;
    }
    
    .session-preview {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-top: 0.5rem;
        display: none;
    }
    
    .capacity-indicator {
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    .preview-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.5rem;
        font-size: 0.875rem;
    }
    
    /* New styles for dynamic section field */
    .section-field-container {
        transition: all 0.3s ease;
    }
    
    .section-preview {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 0.375rem;
        padding: 0.5rem;
        margin-top: 0.5rem;
        display: none;
    }
    
    .section-badge {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
        border-radius: 0.25rem;
    }
    
    .no-section-alert {
        border: 1px solid #b3d7ff;
        background-color: #e8f4f8;
        color: #0c5460;
        margin-bottom: 0;
    }
    
    .section-loading {
        text-align: center;
        padding: 1rem;
        color: #6c757d;
    }
    
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.125em;
    }
</style>
{% endblock %}

{% block content %}
<div class="app-page-title">
    <div class="page-title-wrapper">
        <div class="page-title-heading">
            <div class="page-title-icon">
                <i class="pe-7s-users icon-gradient bg-arielle-smile"></i>
            </div>
            <div>
                {{ title }}
                <div class="page-title-subheading">
                    {% if class_obj %}
                        Update class information and assignments
                    {% else %}
                        Create a new academic class for the current session
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="page-title-actions">
            <a href="{% url 'academics:class_list' %}" class="btn-shadow btn btn-secondary back-button">
                <span class="btn-icon-wrapper pe-2 opacity-7">
                    <i class="fa fa-arrow-left"></i>
                </span>
                Back to List
            </a>
        </div>
    </div>
</div>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'academics:class_list' %}">Classes</a></li>
        <li class="breadcrumb-item active" aria-current="page">
            {% if class_obj %}Edit {{ class_obj }}{% else %}Add New Class{% endif %}
        </li>
    </ol>
</nav>

<!-- Messages -->
{% if messages %}
<div class="row mb-3">
    <div class="col-md-12">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="fa fa-{% if message.tags == 'error' %}exclamation-circle{% elif message.tags == 'success' %}check-circle{% else %}info-circle{% endif %} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-md-12">
        <div class="main-card mb-3 card form-container">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="pe-7s-users me-2"></i>
                    {% if class_obj %}Update Class{% else %}Create New Class{% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <!-- Basic Class Information Section -->
                    <div class="section-title">
                        <i class="fa fa-graduation-cap me-2"></i>Basic Class Information
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="{{ form.academic_level.id_for_label }}" class="form-label required-field">Academic Level</label>
                                {{ form.academic_level }}
                                {% if form.academic_level.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.academic_level.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="help-text">Select the academic level (e.g., Grade 1, Form 1)</div>
                                <div class="level-preview" id="levelPreview">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong id="levelName">Level Information</strong>
                                            <div id="levelType" class="small opacity-75"></div>
                                        </div>
                                        <div class="text-end">
                                            <div id="levelOrder" class="small">Order: -</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Updated Section Field with Dynamic Visibility -->
                        <div class="col-md-6">
                            <div class="mb-3 section-field-container" style="display: none;">
                                <label for="{{ form.section.id_for_label }}" class="form-label">
                                    Section
                                    <span class="section-required-indicator" style="display: none;">
                                        <span class="text-danger">*</span>
                                    </span>
                                </label>
                                {{ form.section }}
                                {% if form.section.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.section.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="help-text section-help-text">Section will be shown if the academic level supports sections</div>
                                
                                <!-- Section preview for levels with sections -->
                                <div class="section-preview" id="sectionPreview" style="display: none;">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-white text-primary section-badge" id="sectionBadge">A</span>
                                        <small class="opacity-75">Section preview</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Session & Teachers Section -->
                    <div class="section-title">
                        <i class="fa fa-calendar-alt me-2"></i>Session & Teaching Staff
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.academic_session.id_for_label }}" class="form-label required-field">Academic Session</label>
                                {{ form.academic_session }}
                                {% if form.academic_session.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.academic_session.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="help-text">Academic year or session for this class</div>
                                <div class="session-preview" id="sessionPreview">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong id="sessionName">Session Information</strong>
                                            <div id="sessionDates" class="small opacity-75"></div>
                                        </div>
                                        <div id="sessionStatus" class="badge bg-light text-dark">
                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.class_teacher.id_for_label }}" class="form-label">Class Teacher</label>
                                {{ form.class_teacher }}
                                {% if form.class_teacher.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.class_teacher.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="help-text">Primary teacher responsible for this class</div>
                                <div class="teacher-preview" id="teacherPreview">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <div class="bg-white text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; font-weight: bold;">
                                                <span id="teacherInitials">--</span>
                                            </div>
                                        </div>
                                        <div>
                                            <strong id="teacherName">Teacher Information</strong>
                                            <div id="teacherRole" class="small opacity-75">Class Teacher</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.assistant_teacher.id_for_label }}" class="form-label">Assistant Teacher</label>
                                {{ form.assistant_teacher }}
                                {% if form.assistant_teacher.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.assistant_teacher.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="help-text">Optional assistant teacher for this class</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.classroom.id_for_label }}" class="form-label">Primary Classroom</label>
                                {{ form.classroom }}
                                {% if form.classroom.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.classroom.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="help-text">Main classroom assigned to this class</div>
                            </div>
                        </div>
                    </div>

                    <!-- Capacity & Schedule Section -->
                    <div class="section-title">
                        <i class="fa fa-cogs me-2"></i>Capacity & Schedule
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.max_students.id_for_label }}" class="form-label required-field">Maximum Students</label>
                                {{ form.max_students }}
                                {% if form.max_students.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.max_students.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="help-text">Maximum number of students allowed in this class</div>
                                <div class="capacity-indicator" id="capacityIndicator">
                                    <div class="d-flex justify-content-between">
                                        <span>Current Enrollment:</span>
                                        <span>
                                            {% if class_obj %}
                                                <strong class="text-primary">{{ class_obj.get_current_enrollment_count }}</strong>
                                            {% else %}
                                                <strong class="text-muted">0</strong>
                                            {% endif %}
                                        </span>
                                    </div>
                                    {% if class_obj %}
                                    <div class="progress mt-1" style="height: 6px;">
                                        {% widthratio class_obj.get_current_enrollment_count class_obj.max_students 100 as current_percentage %}
                                        <div class="progress-bar 
                                            {% if current_percentage < 50 %}bg-success
                                            {% elif current_percentage < 80 %}bg-warning
                                            {% elif current_percentage < 95 %}bg-info
                                            {% else %}bg-danger{% endif %}" 
                                             style="width: {{ current_percentage }}%">
                                        </div>
                                    </div>
                                    <small class="text-muted">{{ current_percentage }}% capacity</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.class_schedule.id_for_label }}" class="form-label">Class Schedule</label>
                                {{ form.class_schedule }}
                                {% if form.class_schedule.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.class_schedule.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="help-text">Optional schedule details for this class</div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Section -->
                    <div class="section-title">
                        <i class="fa fa-toggle-on me-2"></i>Status & Settings
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="info-card" id="activeStatusCard">
                                <div class="form-check">
                                    {{ form.is_active }}
                                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                        <i class="fa fa-check-circle me-2 text-success"></i>
                                        <strong>Active Status</strong>
                                        <div class="help-text">Class is active and available for enrollment</div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            {% if class_obj %}
                            <div class="info-card">
                                <h6><i class="fa fa-info-circle me-2"></i>Class Statistics</h6>
                                <div class="preview-stats">
                                    <span>Subjects:</span>
                                    <strong>{{ class_obj.subjects.count }}</strong>
                                </div>
                                <div class="preview-stats">
                                    <span>Enrollments:</span>
                                    <strong>{{ class_obj.get_current_enrollment_count }}</strong>
                                </div>
                                <div class="preview-stats">
                                    <span>Created:</span>
                                    <strong>{{ class_obj.created_at|date:"M d, Y" }}</strong>
                                </div>
                            </div>
                            {% else %}
                            <div class="info-card">
                                <h6><i class="fa fa-lightbulb me-2"></i>Quick Tips</h6>
                                <ul class="mb-0 small">
                                    <li>Choose a unique section identifier</li>
                                    <li>Assign qualified teachers</li>
                                    <li>Set appropriate student capacity</li>
                                    <li>Select a suitable classroom</li>
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                        <a href="{% url 'academics:class_list' %}" class="btn btn-secondary">
                            <i class="fa fa-times me-2"></i>Cancel
                        </a>
                        <div>
                            {% if class_obj %}
                                <a href="{% url 'academics:class_detail' class_obj.pk %}" class="btn btn-outline-primary me-2">
                                    <i class="fa fa-eye me-2"></i>View Details
                                </a>
                            {% endif %}
                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-save me-2"></i>
                                {% if class_obj %}Update Class{% else %}Create Class{% endif %}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    // Global variables
    let currentLevelHasSections = false;
    
    // Add Bootstrap validation classes to form elements
    $('.form-control, .form-select').addClass('form-control');
    $('.form-check-input').addClass('form-check-input');
    
    // Handle info card styling for checkboxes
    $('.form-check-input').change(function() {
        var checkbox = $(this);
        var container = checkbox.closest('.info-card');
        
        if (checkbox.is(':checked')) {
            container.addClass('selected');
        } else {
            container.removeClass('selected');
        }
    });
    
    // Initialize checkbox states on page load
    $('.form-check-input').each(function() {
        var checkbox = $(this);
        var container = checkbox.closest('.info-card');
        
        if (checkbox.is(':checked')) {
            container.addClass('selected');
        }
    });
    
    // ===============================================================
    // DYNAMIC SECTION FIELD MANAGEMENT
    // ===============================================================
    
    // Function to check if selected academic level has sections
    function checkLevelSections() {
        var levelId = $('#{{ form.academic_level.id_for_label }}').val();
        
        if (levelId) {
            // Show loading state
            showSectionLoading();
            
            // Make AJAX call to check if level has sections
            $.ajax({
                url: '#',
                type: 'GET',
                data: {
                    'level_id': levelId
                },
                success: function(response) {
                    currentLevelHasSections = response.has_sections;
                    
                    if (response.has_sections) {
                        showSectionField(response);
                        updateLevelPreview(response);
                    } else {
                        hideSectionField();
                        showNoSectionMessage(response);
                        updateLevelPreview(response);
                    }
                },
                error: function() {
                    console.log('Error checking level sections');
                    hideSectionLoading();
                    // Default to showing section field on error
                    showSectionField();
                }
            });
        } else {
            // No level selected, hide everything
            hideSectionField();
            hideNoSectionMessage();
            $('#{{ form.section.id_for_label }}').prop('required', false).val('');
            currentLevelHasSections = false;
        }
    }
    
    // Show loading state
    function showSectionLoading() {
        $('.section-field-container').hide();
        $('.no-section-alert').remove();
        if ($('.section-loading').length === 0) {
            $('.section-field-container').parent().append(
                '<div class="section-loading text-center py-3">' +
                '<div class="spinner-border spinner-border-sm text-primary" role="status"></div>' +
                '<span class="ms-2 text-muted">Checking level configuration...</span>' +
                '</div>'
            );
        }
        $('.section-loading').show();
    }
    
    // Hide loading state
    function hideSectionLoading() {
        $('.section-loading').hide();
    }
    
    // Function to show section field
    function showSectionField(levelData = null) {
        hideSectionLoading();
        hideNoSectionMessage();
        
        $('.section-field-container').slideDown(300);
        $('#{{ form.section.id_for_label }}').prop('required', true);
        $('.section-required-indicator').show();
        
        if (levelData) {
            $('.section-help-text').html(
                `<i class="fa fa-info-circle text-primary me-1"></i>` +
                `Enter section for <strong>${levelData.level_name}</strong> (e.g., A, B, C, Alpha, Beta)`
            );
        } else {
            $('.section-help-text').text('Section identifier (e.g., A, B, C, Alpha, Beta)');
        }
        
        // Focus on section field
        setTimeout(() => {
            $('#{{ form.section.id_for_label }}').focus();
        }, 350);
    }
    
    // Function to hide section field
    function hideSectionField() {
        hideSectionLoading();
        $('.section-field-container').slideUp(300);
        $('#{{ form.section.id_for_label }}').prop('required', false).val('').removeClass('is-invalid is-valid');
        $('.section-required-indicator').hide();
        $('#sectionPreview').hide();
    }
    
    // Show message for levels without sections
    function showNoSectionMessage(levelData) {
        hideNoSectionMessage();
        
        if (levelData) {
            const message = `
                <div class="alert alert-info no-section-alert">
                    <div class="d-flex align-items-center">
                        <i class="fa fa-info-circle text-info me-3 fs-4"></i>
                        <div>
                            <strong>No Sections Required</strong><br>
                            <small>
                                <strong>${levelData.level_name}</strong> does not use sections. 
                                All students will be in a single group.
                            </small>
                        </div>
                    </div>
                </div>
            `;
            
            $('.section-field-container').parent().append(message);
            $('.no-section-alert').hide().slideDown(300);
        }
    }
    
    // Hide no section message
    function hideNoSectionMessage() {
        $('.no-section-alert').slideUp(300, function() {
            $(this).remove();
        });
    }
    
    // Update level preview with additional info
    function updateLevelPreview(levelData) {
        if (levelData && $('#levelPreview').length) {
            $('#levelName').text(levelData.level_name);
            $('#levelType').html(
                `<span class="badge bg-secondary me-2">${levelData.level_code}</span>` +
                `${levelData.has_sections ? 'Has Sections' : 'Single Group'}`
            );
            $('#levelOrder').text(`Order: ${levelData.level_order}`);
            
            if (levelData.is_graduation_level) {
                $('#levelType').append(' <span class="badge bg-warning text-dark">Graduation Level</span>');
            }
            
            $('#levelPreview').slideDown();
        }
    }
    
    // Section input enhancement
    $('#{{ form.section.id_for_label }}').on('input', function() {
        var value = this.value.toUpperCase().trim();
        this.value = value;
        
        // Show preview if value exists
        if (value && currentLevelHasSections) {
            $('#sectionBadge').text(value);
            $('#sectionPreview').slideDown();
        } else {
            $('#sectionPreview').slideUp();
        }
        
        // Validate section format
        var isValid = /^[A-Z0-9\-_]+$/.test(value) || value === '';
        
        if (isValid || value === '') {
            $(this).removeClass('is-invalid');
            if (value !== '') {
                $(this).addClass('is-valid');
            }
        } else {
            $(this).removeClass('is-valid').addClass('is-invalid');
        }
    });
    
    // Bind change event to academic level dropdown
    $('#{{ form.academic_level.id_for_label }}').on('change', function() {
        checkLevelSections();
    });
    
    // ===============================================================
    // EXISTING PREVIEW FUNCTIONS (UPDATED)
    // ===============================================================
    
    // Academic Session selection preview
    $('#{{ form.academic_session.id_for_label }}').change(function() {
        var selectedOption = $(this).find('option:selected');
        var sessionText = selectedOption.text();
        
        if (sessionText && sessionText !== '---------') {
            $('#sessionName').text(sessionText);
            $('#sessionDates').text('Academic Session');
            $('#sessionStatus').text('Selected').removeClass('bg-light text-dark').addClass('bg-white text-primary');
            $('#sessionPreview').slideDown();
        } else {
            $('#sessionPreview').slideUp();
        }
    });
    
    // Class Teacher selection preview
    $('#{{ form.class_teacher.id_for_label }}').change(function() {
        var selectedOption = $(this).find('option:selected');
        var teacherText = selectedOption.text();
        
        if (teacherText && teacherText !== '---------') {
            var nameParts = teacherText.trim().split(' ');
            var initials = '';
            if (nameParts.length >= 2) {
                initials = nameParts[0].charAt(0) + nameParts[nameParts.length - 1].charAt(0);
            } else if (nameParts.length === 1) {
                initials = nameParts[0].charAt(0) + nameParts[0].charAt(1);
            }
            
            $('#teacherInitials').text(initials.toUpperCase());
            $('#teacherName').text(teacherText);
            $('#teacherRole').text('Class Teacher');
            $('#teacherPreview').slideDown();
        } else {
            $('#teacherPreview').slideUp();
        }
    });
    
    // Auto-suggest capacity based on classroom
    $('#{{ form.classroom.id_for_label }}').change(function() {
        var selectedOption = $(this).find('option:selected');
        var classroomText = selectedOption.text();
        
        if (classroomText && classroomText !== '---------') {
            console.log('Classroom selected:', classroomText);
        }
    });
    
    // Capacity validation and visual feedback
    $('#{{ form.max_students.id_for_label }}').on('input', function() {
        var capacity = parseInt(this.value);
        var isValid = capacity >= 1 && capacity <= 200;
        
        if (isValid) {
            $(this).removeClass('is-invalid').addClass('is-valid');
            
            // Update capacity indicator
            var currentEnrollment = {% if class_obj %}{{ class_obj.get_current_enrollment_count }}{% else %}0{% endif %};
            if (currentEnrollment > capacity) {
                $('#capacityIndicator').append('<div class="alert alert-warning alert-sm mt-2"><small><i class="fa fa-exclamation-triangle me-1"></i>Current enrollment exceeds new capacity!</small></div>');
            } else {
                $('#capacityIndicator .alert').remove();
            }
        } else {
            $(this).removeClass('is-valid').addClass('is-invalid');
        }
    });
    
    // ===============================================================
    // ENHANCED FORM VALIDATION
    // ===============================================================
    
    // Enhanced form validation
    $('.needs-validation').on('submit', function(e) {
        var form = this;
        var isValid = true;
        
        // Check required fields
        $(form).find('[required]').each(function() {
            if (!this.value || this.value === '') {
                isValid = false;
                $(this).addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid');
            }
        });
        
        // Validate section based on current level requirements
        var levelId = $('#{{ form.academic_level.id_for_label }}').val();
        var sectionValue = $('#{{ form.section.id_for_label }}').val().trim();
        
        if (levelId && currentLevelHasSections) {
            // Section is required for levels with sections
            if (!sectionValue) {
                $('#{{ form.section.id_for_label }}').addClass('is-invalid');
                $('.section-help-text').html(
                    '<span class="text-danger"><i class="fa fa-exclamation-circle me-1"></i>Section is required for this academic level</span>'
                );
                isValid = false;
            } else if (!/^[A-Z0-9\-_]+$/.test(sectionValue)) {
                $('#{{ form.section.id_for_label }}').addClass('is-invalid');
                $('.section-help-text').html(
                    '<span class="text-danger"><i class="fa fa-exclamation-circle me-1"></i>Section must contain only letters, numbers, hyphens, or underscores</span>'
                );
                isValid = false;
            }
        } else if (levelId && !currentLevelHasSections && sectionValue) {
            // Clear section value if level doesn't use sections
            $('#{{ form.section.id_for_label }}').val('');
        }
        
        // Validate capacity
        var capacity = parseInt($('#{{ form.max_students.id_for_label }}').val());
        if (!capacity || capacity < 1 || capacity > 200) {
            $('#{{ form.max_students.id_for_label }}').addClass('is-invalid');
            isValid = false;
        }
        
        // Check for duplicate class combination
        var level = $('#{{ form.academic_level.id_for_label }}').val();
        var sessionVal = $('#{{ form.academic_session.id_for_label }}').val();
        var sectionVal = $('#{{ form.section.id_for_label }}').val();
        
        if (level && sessionVal && sectionVal) {
            console.log('Validating class combination:', level, sessionVal, sectionVal);
        }
        
        if (!isValid) {
            e.preventDefault();
            e.stopPropagation();
            
            // Scroll to first error
            var firstError = $('.is-invalid').first();
            if (firstError.length) {
                $('html, body').animate({
                    scrollTop: firstError.offset().top - 100
                }, 500);
            }
        }
        
        form.classList.add('was-validated');
    });
    
    // Real-time validation for required fields
    $('[required]').on('blur', function() {
        if (this.value && this.value !== '') {
            $(this).removeClass('is-invalid').addClass('is-valid');
        } else {
            $(this).removeClass('is-valid').addClass('is-invalid');
        }
    });
    
    // Clear section validation when field is hidden
    function clearSectionValidation() {
        $('#{{ form.section.id_for_label }}').removeClass('is-invalid is-valid');
        $('.section-help-text').text('Section will be shown if the academic level supports sections');
    }
    
    // ===============================================================
    // FORM CHANGE DETECTION
    // ===============================================================
    
    // Show confirmation before leaving with unsaved changes
    var formChanged = false;
    $('form input, form select, form textarea').on('change', function() {
        formChanged = true;
    });
    
    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
    
    // Don't show confirmation when form is submitted
    $('form').on('submit', function() {
        formChanged = false;
    });
    
    // ===============================================================
    // INITIALIZATION
    // ===============================================================
    
    // Check on page load
    {% if class_obj %}
        // For existing classes, check the current level
        checkLevelSections();
        
        // Initialize previews if editing existing class
        $('#{{ form.academic_session.id_for_label }}').trigger('change');
        $('#{{ form.class_teacher.id_for_label }}').trigger('change');
    {% else %}
        // For new classes, hide section field initially
        hideSectionField();
        hideNoSectionMessage();
    {% endif %}
});
</script>
{% endblock %}