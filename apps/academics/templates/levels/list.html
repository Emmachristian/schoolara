{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
    .level-card {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        padding: 15px;
        text-align: center;
    }
    .level-type-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    .level-actions {
        white-space: nowrap;
    }
    .progression-arrow {
        color: #28a745;
        font-size: 1.2rem;
    }
    .level-order {
        font-weight: 600;
        color: #495057;
        background: #e9ecef;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
    }
    .level-stats {
        display: flex;
        gap: 1rem;
        align-items: center;
        justify-content: center;
    }
    .stat-item {
        text-align: center;
    }
    .stat-number {
        font-size: 1.25rem;
        font-weight: 600;
        color: #495057;
    }
    .stat-label {
        font-size: 0.75rem;
        color: #6c757d;
        text-transform: uppercase;
    }
    .level-card:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
    }
    .graduation-badge {
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #333;
        border: 2px solid #ffd700;
        font-weight: 600;
    }
    .badge-yes { 
        background-color: #28a745; 
    }
    .badge-no { 
        background-color: #dc3545; 
    }
    .level-hierarchy {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: center;
    }
    .hierarchy-item {
        background: #e9ecef;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
    }
    .age-range {
        font-size: 0.875rem;
        color: #495057;
    }
    .level-code {
        background-color: #f8f9fa;
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
    }

    /* Statistics Summary Styles */
    .stats-card {
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stats-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: rgba(255, 255, 255, 0.1);
        transform: rotate(45deg);
        transition: all 0.5s ease;
    }

    .stats-card:hover::before {
        top: -60%;
        right: -60%;
    }

    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
    }

    /* Individual Card Gradient Colors */
    .col-md-3:nth-child(1) .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .col-md-3:nth-child(2) .stats-card {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
    }

    .col-md-3:nth-child(3) .stats-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }

    .col-md-3:nth-child(4) .stats-card {
        background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
        color: white;
    }

    /* Enhanced stats card content */
    .stats-card h3 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stats-card p {
        font-size: 1rem;
        font-weight: 500;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }

    .stats-card small {
        font-size: 0.85rem;
    }

    .stats-card i {
        font-size: 1rem;
        opacity: 0.9;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .stats-summary {
            padding: 15px;
        }
        
        .stats-card {
            margin-bottom: 10px;
        }
        
        .stats-card h3 {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="app-page-title">
    <div class="page-title-wrapper">
        <div class="page-title-heading">
            <div class="page-title-icon">
                <i class="pe-7s-notebook icon-gradient bg-happy-itmeo"></i>
            </div>
            <div>
                Academic Levels
                <div class="page-title-subheading">
                    Manage and view all academic levels/classes
                </div>
            </div>
        </div>
        <div class="page-title-actions">
            <div class="ms-2">
                <div class="btn-group" role="group">
                    <a href="{% url 'academics:academic_level_create' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i> Add New Level
                    </a>

                    <!-- Excel Export -->
                    <a href="#" id="excelExportBtn" class="btn btn-outline-success">
                        <i class="fa fa-file-excel me-1"></i> Export Excel
                    </a>

                    <!-- PDF Export -->
                    <a href="#" id="pdfExportBtn" class="btn btn-outline-danger">
                        <i class="fa fa-file-pdf me-1"></i> Export PDF
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Summary -->
<div class="stats-summary">
    <div class="row">
        <!-- Total Levels -->
        <div class="col-md-3">
            <div class="stats-card text-center p-3">
                <h3 class="mb-1">{{ stats.total_levels|default:0 }}</h3>
                <p class="mb-0 opacity-8">Total Levels</p>
                <small class="opacity-6">
                    <i class="fa fa-layer-group me-1"></i>
                    All levels
                </small>
            </div>
        </div>
        
        <!-- Active Levels -->
        <div class="col-md-3">
            <div class="stats-card text-center p-3">
                <h3 class="mb-1">{{ stats.active_levels|default:0 }}</h3>
                <p class="mb-0 opacity-8">Active Levels</p>
                <small class="opacity-6">
                    <i class="fa fa-check-circle me-1"></i>
                    Currently active
                </small>
            </div>
        </div>
        
        <!-- Inactive Levels -->
        <div class="col-md-3">
            <div class="stats-card text-center p-3">
                <h3 class="mb-1">{{ stats.inactive_levels|default:0 }}</h3>
                <p class="mb-0 opacity-8">Inactive Levels</p>
                <small class="opacity-6">
                    <i class="fa fa-times-circle me-1"></i>
                    Not active
                </small>
            </div>
        </div>
        
        <!-- Graduation Levels -->
        <div class="col-md-3">
            <div class="stats-card text-center p-3">
                <h3 class="mb-1">{{ stats.graduation_levels|default:0 }}</h3>
                <p class="mb-0 opacity-8">Graduation Levels</p>
                <small class="opacity-6">
                    <i class="fa fa-graduation-cap me-1"></i>
                    Final levels
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Levels Table -->
<div class="main-card mb-3 card">
    <div class="card-body">

        <!-- Search & Filter -->
        <section class="section mb-4">
            <form id="levelSearchForm" class="row g-2">
                <div class="col-md-6">
                    <input type="text" name="q" id="levelSearchInput" class="form-control" placeholder="Search by name or code...">
                </div>
                <div class="col-md-2">
                    <select name="is_active" id="activeFilter" class="form-select">
                        <option value="">All Status</option>
                        <option value="True">Active</option>
                        <option value="False">Inactive</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select name="has_sections" id="sectionsFilter" class="form-select">
                        <option value="">All Sections</option>
                        <option value="True">Has Sections</option>
                        <option value="False">No Sections</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select name="is_graduation_level" id="graduationFilter" class="form-select">
                        <option value="">All Levels</option>
                        <option value="True">Graduation Level</option>
                        <option value="False">Regular Level</option>
                    </select>
                </div>
            </form>
        </section>

        <div class="table-responsive">
            <div id="levelResults">
                <table class="table table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 60px;">Order</th>
                            <th>Level Details</th>
                            <th>Current Stats</th>
                            <th>Progression</th>
                            <th>Status</th>
                            <th style="width: 120px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="levelTableBody">
                        {% for level in levels %}
                        <tr data-level-id="{{ level.id }}">
                            <td>
                                <div class="level-order">{{ level.order }}</div>
                            </td>
                            <td>
                                <div>
                                    <strong>{{ level.name }}</strong>
                                    {% if level.is_graduation_level %}
                                        <span class="badge graduation-badge ms-2">
                                            <i class="fa fa-graduation-cap me-1"></i>Graduation
                                        </span>
                                    {% endif %}
                                    <br>
                                    <code class="level-code">{{ level.code }}</code>
                                    {% if level.has_sections %}
                                        <span class="badge bg-info ms-1">
                                            <i class="fa fa-layer-group me-1"></i>Sections
                                        </span>
                                    {% endif %}
                                    {% if level.description %}
                                    <br><small class="text-muted">{{ level.description|truncatechars:60 }}</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="level-stats">
                                    <div class="stat-item">
                                        <div class="stat-number">{{ level.current_enrollment|default:0 }}</div>
                                        <div class="stat-label">Students</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">{{ level.active_classes_count|default:0 }}</div>
                                        <div class="stat-label">Classes</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if level.next_level %}
                                <div class="level-hierarchy">
                                    <span class="hierarchy-item">{{ level.code }}</span>
                                    <i class="fa fa-arrow-right progression-arrow"></i>
                                    <span class="hierarchy-item">{{ level.next_level.code }}</span>
                                </div>
                                {% else %}
                                <span class="badge bg-secondary">
                                    <i class="fa fa-stop me-1"></i>Terminal Level
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if level.is_active %}
                                    <span class="badge bg-success">
                                        <i class="fa fa-check-circle me-1"></i>Active
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger">
                                        <i class="fa fa-times-circle me-1"></i>Inactive
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-light btn-sm">Actions</button>
                                    <button
                                        type="button"
                                        class="btn btn-light btn-sm dropdown-toggle dropdown-toggle-split"
                                        data-bs-toggle="dropdown"
                                        aria-expanded="false">
                                        <span class="visually-hidden">Toggle Dropdown</span>
                                    </button>

                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item text-info" href="">
                                                <i class="fa fa-eye me-1"></i> View
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item text-warning" href="{% url 'academics:academic_level_update' level.pk %}">
                                                <i class="fa fa-edit me-1"></i> Edit
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-danger" href="#" data-level-id="{{ level.id }}" class="delete-level">
                                                <i class="fa fa-trash me-1"></i> Delete
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="fa fa-info-circle fa-2x mb-2"></i>
                                <p>No academic levels found.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- Pagination -->
                <div id="paginationContainer" style="display: none;">
                    <nav class="mb-3" aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="paginationNav">
                            <!-- Pagination will be dynamically inserted here -->
                        </ul>
                    </nav>

                    <!-- Showing X-Y of Z results -->
                    <div class="text-center text-muted mb-3" id="resultsCount">
                        <!-- Results count will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    // ------------------------------------------------------------------------
    // Main Fetch Function
    // ------------------------------------------------------------------------
    function fetchLevels(page = 1) {
        const formData = $('#levelSearchForm').serialize() + `&page=${page}`;
        
        $.ajax({
            url: "{% url 'academics:academic_level_search' %}",
            data: formData,
            dataType: 'json',
            success: function(data) {
                updateLevelTable(data);
                updatePagination(data);
                updateExportLinks();
            },
            error: function(xhr, status, error) {
                console.error('Error fetching levels:', error);
                $('#levelTableBody').html(
                    '<tr><td colspan="7" class="text-center text-danger py-4">' +
                    '<i class="fa fa-exclamation-triangle fa-2x mb-2"></i>' +
                    '<p>Error loading levels. Please try again.</p>' +
                    '</td></tr>'
                );
            }
        });
    }

    // ------------------------------------------------------------------------
    // Table Update Function
    // ------------------------------------------------------------------------
    function updateLevelTable(data) {
        let tbody = '';
        
        if(data.levels.length > 0){
            data.levels.forEach(function(level){
     
                // Graduation Badge
                const graduationBadge = level.is_graduation_level 
                    ? '<span class="badge graduation-badge ms-2"><i class="fa fa-graduation-cap me-1"></i>Graduation</span>'
                    : '';
                
                // Sections Badge
                const sectionsBadge = level.has_sections 
                    ? '<span class="badge bg-info ms-1"><i class="fa fa-layer-group me-1"></i>Sections</span>'
                    : '';
                
                // Description
                const description = level.description 
                    ? `<br><small class="text-muted">${level.description.substring(0, 60)}${level.description.length > 60 ? '...' : ''}</small>`
                    : '';
                
                // Progression
                const progression = level.next_level 
                    ? `<div class="level-hierarchy">
                        <span class="hierarchy-item">${level.code}</span>
                        <i class="fa fa-arrow-right progression-arrow"></i>
                        <span class="hierarchy-item">${level.next_level_code}</span>
                       </div>`
                    : '<span class="badge bg-secondary"><i class="fa fa-stop me-1"></i>Terminal Level</span>';
                
                // Status Badge
                const statusBadge = level.is_active
                    ? '<span class="badge bg-success"><i class="fa fa-check-circle me-1"></i>Active</span>'
                    : '<span class="badge bg-danger"><i class="fa fa-times-circle me-1"></i>Inactive</span>';
                
                // Build row
                tbody += `
                    <tr data-level-id="${level.id}">
                        <td><div class="level-order">${level.order}</div></td>
                        <td>
                            <div>
                                <strong>${level.name}</strong>
                                ${graduationBadge}
                                <br>
                                <code class="level-code">${level.code}</code>
                                ${sectionsBadge}
                                ${description}
                            </div>
                        </td>
                        <td>
                            <div class="level-stats">
                                <div class="stat-item">
                                    <div class="stat-number">${level.current_enrollment || 0}</div>
                                    <div class="stat-label">Students</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number">${level.active_classes_count || 0}</div>
                                    <div class="stat-label">Classes</div>
                                </div>
                            </div>
                        </td>
                        <td>${progression}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-light btn-sm">Actions</button>
                                <button type="button" class="btn btn-light btn-sm dropdown-toggle dropdown-toggle-split"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    <span class="visually-hidden">Toggle Dropdown</span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item text-info" href="/academics/levels/${level.id}/">
                                            <i class="fa fa-eye me-1"></i> View
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-warning" href="/academics/levels/${level.id}/update/">
                                            <i class="fa fa-edit me-1"></i> Edit
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-danger delete-level" href="#" data-level-id="${level.id}">
                                            <i class="fa fa-trash me-1"></i> Delete
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                `;
            });
        } else {
            tbody = `<tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="fa fa-info-circle fa-2x mb-2"></i>
                    <p>No academic levels found matching your filters.</p>
                </td>
            </tr>`;
        }
        
        $('#levelTableBody').html(tbody);
    }

    // ------------------------------------------------------------------------
    // Pagination Functions
    // ------------------------------------------------------------------------
    function updatePagination(data) {
        if (data.total_pages <= 1) {
            $('#paginationContainer').hide();
            return;
        }

        $('#paginationContainer').show();
        $('#paginationNav').html(buildPaginationHtml(data));
        $('#resultsCount').html(
            `Showing ${data.start_index} - ${data.end_index} of ${data.total_count} levels`
        );
    }

    function buildPaginationHtml(data) {
        let html = '';

        // Previous button
        html += buildPaginationButton(
            data.has_previous,
            data.current_page - 1,
            '«',
            'Previous'
        );

        // Page numbers
        for (let i = 1; i <= data.total_pages; i++) {
            if (i === data.current_page) {
                html += `
                    <li class="page-item active" aria-current="page">
                        <a class="page-link" href="#">${i}</a>
                    </li>
                `;
            } else if (i > data.current_page - 3 && i < data.current_page + 3) {
                html += `
                    <li class="page-item">
                        <a class="page-link pagination-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `;
            }
        }

        // Next button
        html += buildPaginationButton(
            data.has_next,
            data.current_page + 1,
            '»',
            'Next'
        );

        return html;
    }

    function buildPaginationButton(isEnabled, page, symbol, label) {
        if (isEnabled) {
            return `
                <li class="page-item">
                    <a class="page-link pagination-link" href="#" data-page="${page}" 
                       aria-label="${label}">
                        <span aria-hidden="true">${symbol}</span>
                        <span class="visually-hidden">${label}</span>
                    </a>
                </li>
            `;
        } else {
            return `
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true" 
                       aria-label="${label}">
                        <span aria-hidden="true">${symbol}</span>
                        <span class="visually-hidden">${label}</span>
                    </a>
                </li>
            `;
        }
    }

    // ------------------------------------------------------------------------
    // Export Functions
    // ------------------------------------------------------------------------
    function updateExportLinks() {
        const formData = $('#levelSearchForm').serialize();
        const excelUrl = "{% url 'academics:export_levels_excel' %}" + (formData ? '?' + formData : '');
        const pdfUrl = "{% url 'academics:export_levels_pdf' %}" + (formData ? '?' + formData : '');
        
        $('#excelExportBtn').attr('href', excelUrl);
        $('#pdfExportBtn').attr('href', pdfUrl);
    }

    // ------------------------------------------------------------------------
    // Event Handlers
    // ------------------------------------------------------------------------
    
    // Search and filter changes
    $('#levelSearchInput, #activeFilter, #sectionsFilter, #graduationFilter')
        .on('input change', function() {
            fetchLevels(1);
        });

    // Pagination clicks
    $(document).on('click', '.pagination-link', function(e) {
        e.preventDefault();
        const page = $(this).data('page');
        fetchLevels(page);
        
        // Scroll to top of results
        $('html, body').animate({
            scrollTop: $("#levelResults").offset().top - 100
        }, 300);
    });

    // Delete level confirmation
    $(document).on('click', '.delete-level', function(e) {
        e.preventDefault();
        const levelId = $(this).data('level-id');
        
        if (confirm('Are you sure you want to delete this academic level? This action cannot be undone.')) {
            // Implement delete functionality here
            $.ajax({
                url: `/academics/levels/${levelId}/delete/`,
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(response) {
                    fetchLevels(1);
                    // Show success message
                    alert('Level deleted successfully');
                },
                error: function(xhr, status, error) {
                    console.error('Delete error:', error);
                    alert('Error deleting level. Please try again.');
                }
            });
        }
    });

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ------------------------------------------------------------------------
    // Initialize
    // ------------------------------------------------------------------------
    updateExportLinks();
    fetchLevels(1);
});
</script>
{% endblock %}