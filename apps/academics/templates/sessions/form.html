{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<style>
    .form-section {
        background-color: #fff;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #007bff;
    }
    
    .form-section.break-section {
        border-left-color: #ffc107;
    }
    
    .section-header {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 12px;
        margin-bottom: 20px;
    }
    
    .section-header h5 {
        color: #495057;
        margin-bottom: 4px;
        font-weight: 600;
    }
    
    .section-header p {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 0;
    }
    
    .form-floating {
        margin-bottom: 1rem;
    }
    
    .preview-card {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        position: sticky;
        top: 20px;
    }
    
    .preview-card h6 {
        color: #495057;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 8px;
        margin-bottom: 15px;
    }
    
    .form-help {
        background-color: #e3f2fd;
        border-left: 3px solid #2196f3;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }
    
    .form-help h6 {
        color: #1976d2;
        margin-bottom: 8px;
    }
    
    .btn-save-group {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        margin-top: 30px;
        border: 1px solid #dee2e6;
    }
    
    .validation-feedback {
        display: block;
        margin-top: 0.25rem;
        font-size: 0.875rem;
    }
    
    .validation-feedback.valid {
        color: #28a745;
    }
    
    .validation-feedback.invalid {
        color: #dc3545;
    }
    
    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .invalid-feedback {
        display: block;
    }
    
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }
    
    .quick-fill-btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.75rem;
        margin: 2px;
    }
    
    .duration-info-card {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
        margin-top: 15px;
        border: 1px solid #dee2e6;
    }
    
    .settings-card {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        margin-bottom: 15px;
    }
    
    .settings-card .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 12px 15px;
    }
    
    .settings-card .card-body {
        padding: 15px;
    }
    
    .form-errors {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .form-errors h6 {
        color: #721c24;
        margin-bottom: 10px;
    }
    
    .form-errors ul {
        margin-bottom: 0;
        color: #721c24;
    }
    
    .break-preview-card {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
        padding: 15px;
        margin-top: 15px;
    }
    
    .break-warning {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        padding: 10px;
        margin-top: 10px;
        color: #721c24;
    }
    
    .break-success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 4px;
        padding: 10px;
        margin-top: 10px;
        color: #155724;
    }
    
    .break-info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 4px;
        padding: 10px;
        margin-top: 10px;
        color: #0c5460;
    }
    
    @media (max-width: 768px) {
        .form-section {
            padding: 16px;
        }
        .preview-card {
            position: static;
            margin-bottom: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="app-page-title">
    <div class="page-title-wrapper">
        <div class="page-title-heading">
            <div class="page-title-icon">
                <i class="pe-7s-{% if session %}edit{% else %}add-user{% endif %} icon-gradient bg-mean-fruit"></i>
            </div>
            <div>
                {% if session %}
                    Edit Academic Session
                    <div class="page-title-subheading">
                        Update {{ session.year_name }} - {{ session.term_name }} details and break management
                    </div>
                {% else %}
                    Create Academic Session
                    <div class="page-title-subheading">
                        Add a new academic session with automatic break detection
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="page-title-actions">
            <a href="{% url 'academics:academic_session_list' %}" class="btn btn-outline-secondary me-2">
                <i class="fa fa-arrow-left me-1"></i> Back to List
            </a>
            {% if session %}
                <a href="{% url 'academics:academic_session_detail' session.pk %}" class="btn btn-outline-info me-2">
                    <i class="fa fa-eye me-1"></i> View Details
                </a>
                <a href="#" class="btn btn-outline-warning">
                    <i class="fa fa-calendar-times me-1"></i> Manage Breaks
                </a>
            {% else %}
                <a href="#" class="btn btn-outline-warning">
                    <i class="fa fa-calendar-times me-1"></i> Break Management
                </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Display Form Errors -->
{% if form.errors or form.non_field_errors %}
<div class="form-errors">
    <h6><i class="fa fa-exclamation-triangle me-1"></i> Please correct the following errors:</h6>
    {% if form.non_field_errors %}
        <ul>
            {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    {% if form.errors %}
        <ul>
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                    <li>{{ field|title }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    {% endif %}
</div>
{% endif %}

<!-- Help Section -->
<div class="form-help">
    <h6><i class="fa fa-lightbulb me-1"></i> Quick Tips</h6>
    <ul class="mb-0">
        <li>Fill in the required fields marked with *</li>
        <li>The system will validate dates and check for overlaps automatically</li>
        <li>Enable break management to automatically create breaks between sessions</li>
        <li>Use the preview panel to see how your session will look</li>
        <li>All settings can be updated later if needed</li>
    </ul>
</div>

<form method="post" id="session-form" novalidate>
    {% csrf_token %}
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Basic Information Section -->
            <div class="form-section">
                <div class="section-header">
                    <h5><i class="fa fa-info-circle me-2"></i>Basic Information</h5>
                    <p>Define the academic year, term, and basic session details</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.year_name }}
                            <label for="{{ form.year_name.id_for_label }}">Academic Year *</label>
                            {% if form.year_name.errors %}
                                <div class="invalid-feedback">{{ form.year_name.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">Format: YYYY-YYYY (e.g., 2024-2025) or YYYY</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-floating">
                            <select class="form-select {% if form.term_number.errors %}is-invalid{% endif %}" 
                                    id="term-selector" name="term_selector" required>
                                <option value="">Select {% if school_config %}{{ school_config.get_period_type_name }}{% else %}Period{% endif %}...</option>
                                {% if school_config %}
                                    {% for period_num in school_config.get_all_period_options %}
                                        <option value="{{ period_num.number }}" 
                                                data-name="{{ period_num.name }}"
                                                {% if form.term_number.value == period_num.number %}selected{% endif %}>
                                            {{ period_num.name }}
                                        </option>
                                    {% endfor %}
                                {% else %}
                                    <!-- Fallback options if no configuration -->
                                    <option value="1" data-name="Term 1" {% if form.term_number.value == 1 %}selected{% endif %}>Term 1</option>
                                    <option value="2" data-name="Term 2" {% if form.term_number.value == 2 %}selected{% endif %}>Term 2</option>
                                    <option value="3" data-name="Term 3" {% if form.term_number.value == 3 %}selected{% endif %}>Term 3</option>
                                    <option value="4" data-name="Term 4" {% if form.term_number.value == 4 %}selected{% endif %}>Term 4</option>
                                {% endif %}
                            </select>
                            <label for="term-selector">{% if school_config %}{{ school_config.get_period_type_name }}{% else %}Period{% endif %} *</label>
                            {% if form.term_number.errors %}
                                <div class="invalid-feedback">{{ form.term_number.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="form-text">
                            Academic periods per year
                        </div>
                    </div>
                </div>
                
                <!-- Hidden fields for form submission -->
                {{ form.term_number.as_hidden }}
                {{ form.term_name.as_hidden }}
                {{ form.period_type.as_hidden }}
            </div>
            
            <!-- Duration Information Section -->
            <div class="form-section">
                <div class="section-header">
                    <h5><i class="fa fa-calendar me-2"></i>Duration & Dates</h5>
                    <p>Set the start and end dates for this academic session</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.start_date }}
                            <label for="{{ form.start_date.id_for_label }}">Start Date *</label>
                            {% if form.start_date.errors %}
                                <div class="invalid-feedback">{{ form.start_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.end_date }}
                            <label for="{{ form.end_date.id_for_label }}">End Date *</label>
                            {% if form.end_date.errors %}
                                <div class="invalid-feedback">{{ form.end_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Date Validation Feedback -->
                <div id="date-validation" class="validation-feedback" style="display: none;"></div>
                
                <!-- Duration Info -->
                <div id="duration-info" class="duration-info-card" style="display: none;">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <strong id="total-days">0</strong>
                            <div><small class="text-muted">Total Days</small></div>
                        </div>
                        <div class="col-md-4">
                            <strong id="total-weeks">0</strong>
                            <div><small class="text-muted">Weeks</small></div>
                        </div>
                        <div class="col-md-4">
                            <strong id="total-months">0</strong>
                            <div><small class="text-muted">Months</small></div>
                        </div>
                    </div>
                </div>
                
                <!-- Break Impact Analysis -->
                <div id="break-impact" style="display: none;">
                    <h6 class="mt-3 mb-2"><i class="fa fa-calendar-times me-1"></i> Break Impact Analysis</h6>
                    <div id="break-analysis-results"></div>
                </div>
            </div>
            
            <!-- Break Management Section -->
            <div class="form-section break-section">
                <div class="section-header">
                    <h5><i class="fa fa-calendar-times me-2"></i>Break Management</h5>
                    <p>Configure break detection and automatic creation settings</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="settings-card">
                            <div class="card-header">
                                <h6 class="mb-0">Break Creation Settings</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-3">
                                    {{ form.auto_create_breaks }}
                                    <label class="form-check-label" for="{{ form.auto_create_breaks.id_for_label }}">
                                        <strong>Auto-create Breaks</strong>
                                        <small class="d-block text-muted">Automatically create holiday records for breaks between sessions</small>
                                    </label>
                                    {% if form.auto_create_breaks.errors %}
                                        <div class="invalid-feedback d-block">{{ form.auto_create_breaks.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="form-check mb-3">
                                    {{ form.check_overlaps }}
                                    <label class="form-check-label" for="{{ form.check_overlaps.id_for_label }}">
                                        <strong>Check for Overlaps</strong>
                                        <small class="d-block text-muted">Validate that this session doesn't overlap with existing sessions</small>
                                    </label>
                                    {% if form.check_overlaps.errors %}
                                        <div class="invalid-feedback d-block">{{ form.check_overlaps.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="form-check">
                                    {{ form.preview_breaks }}
                                    <label class="form-check-label" for="{{ form.preview_breaks.id_for_label }}">
                                        <strong>Preview Break Impact</strong>
                                        <small class="d-block text-muted">Show how this session will affect existing breaks</small>
                                    </label>
                                    {% if form.preview_breaks.errors %}
                                        <div class="invalid-feedback d-block">{{ form.preview_breaks.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="settings-card">
                            <div class="card-header">
                                <h6 class="mb-0">Next Session Management</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-3">
                                    {{ form.create_next_session }}
                                    <label class="form-check-label" for="{{ form.create_next_session.id_for_label }}">
                                        <strong>Create Next Session</strong>
                                        <small class="d-block text-muted">Automatically create the next session after this one</small>
                                    </label>
                                    {% if form.create_next_session.errors %}
                                        <div class="invalid-feedback d-block">{{ form.create_next_session.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="form-check">
                                    {{ form.copy_settings_to_next }}
                                    <label class="form-check-label" for="{{ form.copy_settings_to_next.id_for_label }}">
                                        <strong>Copy Settings to Next Session</strong>
                                        <small class="d-block text-muted">Copy financial and academic settings to the next session</small>
                                    </label>
                                    {% if form.copy_settings_to_next.errors %}
                                        <div class="invalid-feedback d-block">{{ form.copy_settings_to_next.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Break Preview -->
                <div id="break-preview" class="break-preview-card" style="display: none;">
                    <h6><i class="fa fa-eye me-1"></i> Break Preview</h6>
                    <div id="break-preview-content">
                        <!-- Content will be loaded via JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Session Settings Section -->
            <div class="form-section">
                <div class="section-header">
                    <h5><i class="fa fa-cogs me-2"></i>Session Settings</h5>
                    <p>Configure session behavior and academic policies</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="settings-card">
                            <div class="card-header">
                                <h6 class="mb-0">Status Settings</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-3">
                                    {{ form.is_current }}
                                    <label class="form-check-label" for="{{ form.is_current.id_for_label }}">
                                        <strong>Set as Current Session</strong>
                                        <small class="d-block text-muted">This will be the active session for new enrollments</small>
                                    </label>
                                    {% if form.is_current.errors %}
                                        <div class="invalid-feedback d-block">{{ form.is_current.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="form-check mb-3">
                                    {{ form.allows_promotion }}
                                    <label class="form-check-label" for="{{ form.allows_promotion.id_for_label }}">
                                        <strong>Allows Student Promotion</strong>
                                        <small class="d-block text-muted">Students can be promoted at the end of this session</small>
                                    </label>
                                    {% if form.allows_promotion.errors %}
                                        <div class="invalid-feedback d-block">{{ form.allows_promotion.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="form-check">
                                    {{ form.registration_fee_required }}
                                    <label class="form-check-label" for="{{ form.registration_fee_required.id_for_label }}">
                                        <strong>Registration Fee Required</strong>
                                        <small class="d-block text-muted">Students must pay registration fees for this session</small>
                                    </label>
                                    {% if form.registration_fee_required.errors %}
                                        <div class="invalid-feedback d-block">{{ form.registration_fee_required.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="settings-card">
                            <div class="card-header">
                                <h6 class="mb-0">Academic Requirements</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-floating mb-3">
                                    {{ form.minimum_attendance_percentage }}
                                    <label for="{{ form.minimum_attendance_percentage.id_for_label }}">Minimum Attendance (%)</label>
                                    {% if form.minimum_attendance_percentage.errors %}
                                        <div class="invalid-feedback">{{ form.minimum_attendance_percentage.errors.0 }}</div>
                                    {% endif %}
                                    <div class="form-text">Required attendance for promotion eligibility</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Save Buttons -->
            <div class="btn-save-group">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                            <i class="fa fa-undo me-1"></i> Reset Form
                        </button>
                        <button type="button" class="btn btn-outline-warning ms-2" onclick="analyzeBreakImpact()">
                            <i class="fa fa-search me-1"></i> Analyze Break Impact
                        </button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-outline-info me-2" onclick="validateForm()">
                            <i class="fa fa-check me-1"></i> Validate
                        </button>
                        <button type="submit" class="btn btn-primary" id="save-session">
                            <span class="spinner-border spinner-border-sm me-1" style="display: none;" id="save-spinner"></span>
                            <i class="fa fa-save me-1" id="save-icon"></i>
                            {% if session %}Update Session{% else %}Create Session{% endif %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Preview Panel -->
        <div class="col-lg-4">
            <div class="preview-card">
                <h6><i class="fa fa-eye me-2"></i>Session Preview</h6>
                
                <div class="mb-3">
                    <strong>Academic Year:</strong>
                    <div id="preview-year" class="text-muted">
                        {% if form.year_name.value %}{{ form.year_name.value }}{% else %}Not specified{% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Term:</strong>
                    <div id="preview-term" class="text-muted">
                        {% if form.term_name.value %}{{ form.term_name.value }}{% else %}Not specified{% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Duration:</strong>
                    <div id="preview-duration" class="text-muted">
                        {% if form.start_date.value and form.end_date.value %}
                            {{ form.start_date.value }} - {{ form.end_date.value }}
                        {% else %}
                            Not specified
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Status:</strong>
                    <div id="preview-status">
                        {% if form.is_current.value %}
                            <span class="badge bg-success">Current Session</span>
                        {% else %}
                            <span class="badge bg-secondary">Draft</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Settings:</strong>
                    <div id="preview-settings" class="text-muted">
                        <div id="preview-current" {% if not form.is_current.value %}style="display: none;"{% endif %}>
                            <i class="fa fa-star me-1 text-warning"></i> Current Session
                        </div>
                        <div id="preview-promotion" {% if not form.allows_promotion.value %}style="display: none;"{% endif %}>
                            <i class="fa fa-graduation-cap me-1 text-success"></i> Allows Promotion
                        </div>
                        <div id="preview-registration" {% if not form.registration_fee_required.value %}style="display: none;"{% endif %}>
                            <i class="fa fa-money-bill me-1 text-info"></i> Registration Required
                        </div>
                        <div id="preview-penalty" {% if not form.late_payment_penalty_rate.value or form.late_payment_penalty_rate.value == '0' %}style="display: none;"{% endif %}>
                            <i class="fa fa-exclamation-triangle me-1 text-warning"></i> 
                            <span id="penalty-rate">{{ form.late_payment_penalty_rate.value|default:'0' }}</span>% Late Penalty
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Break Management:</strong>
                    <div id="preview-breaks" class="text-muted">
                        <div id="preview-auto-breaks" {% if not form.auto_create_breaks.value %}style="display: none;"{% endif %}>
                            <i class="fa fa-calendar-plus me-1 text-warning"></i> Auto-create Breaks
                        </div>
                        <div id="preview-check-overlaps" {% if not form.check_overlaps.value %}style="display: none;"{% endif %}>
                            <i class="fa fa-shield-alt me-1 text-info"></i> Overlap Checking
                        </div>
                        <div id="preview-break-preview" {% if not form.preview_breaks.value %}style="display: none;"{% endif %}>
                            <i class="fa fa-eye me-1 text-primary"></i> Break Preview
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Attendance Requirement:</strong>
                    <div id="preview-attendance" class="text-muted">
                        {{ form.minimum_attendance_percentage.value|default:'75' }}%
                    </div>
                </div>
                
                <hr>
                <div class="text-center">
                    <small class="text-muted">Preview updates as you fill the form</small>
                </div>
            </div>
            
            <!-- Break Impact Preview -->
            <div class="preview-card" id="break-impact-preview" style="display: none;">
                <h6><i class="fa fa-calendar-times me-2"></i>Break Impact</h6>
                <div id="break-impact-content">
                    <!-- Content will be loaded via JavaScript -->
                </div>
            </div>
        </div>
    </div>
</form>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
    updatePreview();
    setupFormValidation();
    setupBreakManagement();
});

// Form initialization
function initializeForm() {
    const startDateInput = document.getElementById('{{ form.start_date.id_for_label }}');
    const endDateInput = document.getElementById('{{ form.end_date.id_for_label }}');
    const termSelector = document.getElementById('term-selector');
    
    // Set up term selector
    if (termSelector) {
        termSelector.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            
            if (selectedOption.value) {
                // Update hidden fields
                document.getElementById('{{ form.term_number.id_for_label }}').value = selectedOption.value;
                document.getElementById('{{ form.term_name.id_for_label }}').value = selectedOption.getAttribute('data-name');
                
                // Auto-set period type
                const periodTypeField = document.getElementById('{{ form.period_type.id_for_label }}');
                if (periodTypeField) {
                    periodTypeField.value = 'term';
                }
            } else {
                // Clear hidden fields
                document.getElementById('{{ form.term_number.id_for_label }}').value = '';
                document.getElementById('{{ form.term_name.id_for_label }}').value = '';
            }
            
            updatePreview();
            analyzeBreakImpact();
        });
        
        // Initialize hidden fields if a term is already selected
        if (termSelector.value) {
            const selectedOption = termSelector.options[termSelector.selectedIndex];
            document.getElementById('{{ form.term_number.id_for_label }}').value = selectedOption.value;
            document.getElementById('{{ form.term_name.id_for_label }}').value = selectedOption.getAttribute('data-name');
            
            // Set period type
            const periodTypeField = document.getElementById('{{ form.period_type.id_for_label }}');
            if (periodTypeField) {
                periodTypeField.value = 'term';
            }
        }
    }
    
    // Set up date validation
    [startDateInput, endDateInput].forEach(input => {
        if (input) {
            input.addEventListener('change', function() {
                validateDates();
                calculateDuration();
                updatePreview();
                if (document.getElementById('{{ form.preview_breaks.id_for_label }}').checked) {
                    analyzeBreakImpact();
                }
            });
        }
    });
    
    // Set up real-time preview updates
    const form = document.getElementById('session-form');
    const inputs = form.querySelectorAll('input:not([type="hidden"]), select');
    
    inputs.forEach(input => {
        input.addEventListener('input', updatePreview);
        input.addEventListener('change', updatePreview);
    });
    
    // Initial validation and calculation
    validateDates();
    calculateDuration();
}

// Setup break management functionality
function setupBreakManagement() {
    const autoCreateBreaks = document.getElementById('{{ form.auto_create_breaks.id_for_label }}');
    const previewBreaks = document.getElementById('{{ form.preview_breaks.id_for_label }}');
    const checkOverlaps = document.getElementById('{{ form.check_overlaps.id_for_label }}');
    
    // Enable/disable break preview based on auto-create setting
    if (autoCreateBreaks) {
        autoCreateBreaks.addEventListener('change', function() {
            updatePreview();
            if (this.checked && previewBreaks) {
                previewBreaks.checked = true;
                previewBreaks.dispatchEvent(new Event('change'));
            }
        });
    }
    
    // Show/hide break preview
    if (previewBreaks) {
        previewBreaks.addEventListener('change', function() {
            const breakPreviewCard = document.getElementById('break-impact-preview');
            if (this.checked) {
                analyzeBreakImpact();
                breakPreviewCard.style.display = 'block';
            } else {
                breakPreviewCard.style.display = 'none';
            }
            updatePreview();
        });
    }
    
    // Update preview when overlap checking is toggled
    if (checkOverlaps) {
        checkOverlaps.addEventListener('change', function() {
            updatePreview();
            if (this.checked && previewBreaks && previewBreaks.checked) {
                analyzeBreakImpact();
            }
        });
    }
}

// Analyze break impact - Using placeholder for now since AJAX endpoints may not exist
function analyzeBreakImpact() {
    const startDate = document.getElementById('{{ form.start_date.id_for_label }}').value;
    const endDate = document.getElementById('{{ form.end_date.id_for_label }}').value;
    
    if (!startDate || !endDate) {
        document.getElementById('break-impact').style.display = 'none';
        document.getElementById('break-impact-preview').style.display = 'none';
        return;
    }
    
    // Simulated break impact analysis for now
    setTimeout(() => {
        displayBreakImpact({
            has_issues: false,
            affected_breaks: [],
            new_gaps: [],
            recommendations: []
        });
    }, 500);
}

// Display break impact analysis results
function displayBreakImpact(data) {
    const breakImpact = document.getElementById('break-impact');
    const breakAnalysisResults = document.getElementById('break-analysis-results');
    const breakImpactPreview = document.getElementById('break-impact-preview');
    const breakImpactContent = document.getElementById('break-impact-content');
    
    let content = '';
    let previewContent = '';
    
    if (data.has_issues) {
        breakImpact.style.display = 'block';
        
        if (data.affected_breaks && data.affected_breaks.length > 0) {
            content += '<div class="break-warning mb-2">';
            content += '<h6><i class="fa fa-exclamation-triangle me-1"></i> Affected Breaks</h6>';
            content += '<ul class="mb-0">';
            data.affected_breaks.forEach(breakInfo => {
                content += `<li><strong>${breakInfo.break_name}:</strong> ${breakInfo.issue}</li>`;
            });
            content += '</ul></div>';
            
            previewContent += `<div class="text-warning mb-2"><i class="fa fa-exclamation-triangle me-1"></i> ${data.affected_breaks.length} break(s) affected</div>`;
        }
        
        if (data.new_gaps && data.new_gaps.length > 0) {
            content += '<div class="break-info mb-2">';
            content += '<h6><i class="fa fa-calendar-plus me-1"></i> New Break Opportunities</h6>';
            content += '<ul class="mb-0">';
            data.new_gaps.forEach(gap => {
                content += `<li>${gap.gap_start} to ${gap.gap_end} (${gap.duration_days} days) - ${gap.position} session</li>`;
            });
            content += '</ul></div>';
            
            previewContent += `<div class="text-info mb-2"><i class="fa fa-calendar-plus me-1"></i> ${data.new_gaps.length} new break(s) possible</div>`;
        }
        
        if (data.recommendations && data.recommendations.length > 0) {
            content += '<div class="break-success">';
            content += '<h6><i class="fa fa-lightbulb me-1"></i> Recommendations</h6>';
            content += '<ul class="mb-0">';
            data.recommendations.forEach(rec => {
                content += `<li>${rec.message}</li>`;
            });
            content += '</ul></div>';
        }
    } else {
        content = '<div class="break-success"><i class="fa fa-check-circle me-1"></i> No break conflicts detected. This session fits well with the existing schedule.</div>';
        previewContent = '<div class="text-success"><i class="fa fa-check-circle me-1"></i> No break conflicts</div>';
        breakImpact.style.display = 'block';
    }
    
    breakAnalysisResults.innerHTML = content;
    breakImpactContent.innerHTML = previewContent;
    
    // Show preview if break preview is enabled
    if (document.getElementById('{{ form.preview_breaks.id_for_label }}').checked) {
        breakImpactPreview.style.display = 'block';
    }
}

// Validate dates
function validateDates() {
    const startDateInput = document.getElementById('{{ form.start_date.id_for_label }}');
    const endDateInput = document.getElementById('{{ form.end_date.id_for_label }}');
    const validationDiv = document.getElementById('date-validation');
    
    if (!startDateInput.value || !endDateInput.value) {
        validationDiv.style.display = 'none';
        return;
    }
    
    const startDate = new Date(startDateInput.value);
    const endDate = new Date(endDateInput.value);
    
    validationDiv.style.display = 'block';
    validationDiv.innerHTML = '';
    
    if (startDate >= endDate) {
        validationDiv.innerHTML = '<i class="fa fa-times me-1"></i>End date must be after start date';
        validationDiv.className = 'validation-feedback invalid';
        return;
    }
    
    const durationDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
    
    if (durationDays < 30) {
        validationDiv.innerHTML = `<i class="fa fa-exclamation-triangle me-1"></i>Session is only ${durationDays} days long. Consider extending it.`;
        validationDiv.className = 'validation-feedback invalid';
    } else if (durationDays > 150) {
        validationDiv.innerHTML = `<i class="fa fa-exclamation-triangle me-1"></i>Session is ${durationDays} days long. This seems quite long for a term.`;
        validationDiv.className = 'validation-feedback invalid';
    } else {
        validationDiv.innerHTML = `<i class="fa fa-check me-1"></i>Session duration: ${durationDays} days (${Math.round(durationDays/7)} weeks)`;
        validationDiv.className = 'validation-feedback valid';
    }
}

// Calculate duration
function calculateDuration() {
    const startDateInput = document.getElementById('{{ form.start_date.id_for_label }}');
    const endDateInput = document.getElementById('{{ form.end_date.id_for_label }}');
    const durationDiv = document.getElementById('duration-info');
    
    if (!startDateInput.value || !endDateInput.value) {
        durationDiv.style.display = 'none';
        return;
    }
    
    const startDate = new Date(startDateInput.value);
    const endDate = new Date(endDateInput.value);
    
    if (startDate >= endDate) {
        durationDiv.style.display = 'none';
        return;
    }
    
    const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
    const totalWeeks = Math.floor(totalDays / 7);
    const totalMonths = Math.round(totalDays / 30.44);
    
    document.getElementById('total-days').textContent = totalDays;
    document.getElementById('total-weeks').textContent = totalWeeks;
    document.getElementById('total-months').textContent = totalMonths;
    
    durationDiv.style.display = 'block';
}

// Update preview
function updatePreview() {
    const yearName = document.getElementById('{{ form.year_name.id_for_label }}').value;
    const termName = document.getElementById('{{ form.term_name.id_for_label }}').value;
    const startDate = document.getElementById('{{ form.start_date.id_for_label }}').value;
    const endDate = document.getElementById('{{ form.end_date.id_for_label }}').value;
    const isCurrent = document.getElementById('{{ form.is_current.id_for_label }}').checked;
    const allowsPromotion = document.getElementById('{{ form.allows_promotion.id_for_label }}').checked;
    const registrationRequired = document.getElementById('{{ form.registration_fee_required.id_for_label }}').checked;
    const penaltyRate = document.getElementById('{{ form.late_payment_penalty_rate.id_for_label }}').value;
    const attendanceRate = document.getElementById('{{ form.minimum_attendance_percentage.id_for_label }}').value;
    
    // Break management settings
    const autoCreateBreaks = document.getElementById('{{ form.auto_create_breaks.id_for_label }}').checked;
    const checkOverlaps = document.getElementById('{{ form.check_overlaps.id_for_label }}').checked;
    const previewBreaks = document.getElementById('{{ form.preview_breaks.id_for_label }}').checked;
    
    // Update preview content
    document.getElementById('preview-year').textContent = yearName || 'Not specified';
    document.getElementById('preview-term').textContent = termName || 'Not specified';
    
    if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
        document.getElementById('preview-duration').innerHTML = 
            `${start.toLocaleDateString()} - ${end.toLocaleDateString()}<br><small class="text-muted">${duration} days</small>`;
    } else {
        document.getElementById('preview-duration').textContent = 'Not specified';
    }
    
    // Update status
    const statusDiv = document.getElementById('preview-status');
    if (isCurrent) {
        statusDiv.innerHTML = '<span class="badge bg-success">Current Session</span>';
    } else {
        statusDiv.innerHTML = '<span class="badge bg-secondary">Draft</span>';
    }
    
    // Update settings preview
    document.getElementById('preview-current').style.display = isCurrent ? 'block' : 'none';
    document.getElementById('preview-promotion').style.display = allowsPromotion ? 'block' : 'none';
    document.getElementById('preview-registration').style.display = registrationRequired ? 'block' : 'none';
    
    const penaltyDiv = document.getElementById('preview-penalty');
    if (penaltyRate && parseFloat(penaltyRate) > 0) {
        document.getElementById('penalty-rate').textContent = penaltyRate;
        penaltyDiv.style.display = 'block';
    } else {
        penaltyDiv.style.display = 'none';
    }
    
    // Update break management preview
    document.getElementById('preview-auto-breaks').style.display = autoCreateBreaks ? 'block' : 'none';
    document.getElementById('preview-check-overlaps').style.display = checkOverlaps ? 'block' : 'none';
    document.getElementById('preview-break-preview').style.display = previewBreaks ? 'block' : 'none';
    
    document.getElementById('preview-attendance').textContent = 
        attendanceRate ? `${attendanceRate}%` : '75%';
}

// Form validation (client-side only)
function validateForm() {
    const form = document.getElementById('session-form');
    const requiredFields = [
        document.getElementById('{{ form.year_name.id_for_label }}'),
        document.getElementById('term-selector'),
        document.getElementById('{{ form.start_date.id_for_label }}'),
        document.getElementById('{{ form.end_date.id_for_label }}')
    ];
    
    let isValid = true;
    let errors = [];
    
    requiredFields.forEach(field => {
        if (field && !field.value.trim()) {
            isValid = false;
            const label = field.labels && field.labels[0] ? 
                field.labels[0].textContent.replace('*', '').trim() : 
                field.name;
            errors.push(`${label} is required`);
            field.classList.add('is-invalid');
        } else if (field) {
            field.classList.remove('is-invalid');
        }
    });
    
    // Validate dates
    const startDate = document.getElementById('{{ form.start_date.id_for_label }}').value;
    const endDate = document.getElementById('{{ form.end_date.id_for_label }}').value;
    
    if (startDate && endDate && new Date(startDate) >= new Date(endDate)) {
        isValid = false;
        errors.push('End date must be after start date');
    }
    
    // Validate term selector
    const termSelector = document.getElementById('term-selector');
    if (termSelector && !termSelector.value) {
        isValid = false;
        errors.push('Period selection is required');
        termSelector.classList.add('is-invalid');
    } else if (termSelector) {
        termSelector.classList.remove('is-invalid');
    }
    
    // Validate year name format
    const yearName = document.getElementById('{{ form.year_name.id_for_label }}').value;
    if (yearName) {
        const yearPattern = /^(20\d{2})(-|\/)(20\d{2})$|^20\d{2}$/;
        if (!yearPattern.test(yearName)) {
            isValid = false;
            errors.push('Year name must be in format "YYYY-YYYY", "YYYY/YYYY", or "YYYY"');
        }
    }
    
    // Validate percentage fields
    const penaltyRate = document.getElementById('{{ form.late_payment_penalty_rate.id_for_label }}').value;
    if (penaltyRate && (parseFloat(penaltyRate) < 0 || parseFloat(penaltyRate) > 100)) {
        isValid = false;
        errors.push('Late payment penalty rate must be between 0 and 100');
    }
    
    const attendanceRate = document.getElementById('{{ form.minimum_attendance_percentage.id_for_label }}').value;
    if (attendanceRate && (parseFloat(attendanceRate) < 0 || parseFloat(attendanceRate) > 100)) {
        isValid = false;
        errors.push('Minimum attendance percentage must be between 0 and 100');
    }
    
    if (isValid) {
        alert('✓ Form validation passed! All fields look good.');
        
        // If break preview is enabled, show break analysis
        if (document.getElementById('{{ form.preview_breaks.id_for_label }}').checked) {
            analyzeBreakImpact();
        }
    } else {
        alert('❌ Form validation failed:\n\n' + errors.join('\n'));
    }
    
    return isValid;
}

// Setup form validation and submission
function setupFormValidation() {
    const form = document.getElementById('session-form');
    
    form.addEventListener('submit', function(e) {
        // Only prevent submission if client-side validation fails
        if (!performBasicValidation()) {
            e.preventDefault();
            return;
        }
        
        // Show loading state
        const saveButton = document.getElementById('save-session');
        const saveIcon = document.getElementById('save-icon');
        const saveSpinner = document.getElementById('save-spinner');
        
        saveButton.disabled = true;
        saveIcon.style.display = 'none';
        saveSpinner.style.display = 'inline-block';
        
        // Form will submit normally - Django will handle server-side validation
    });
}

// Perform basic validation without alerts
function performBasicValidation() {
    const form = document.getElementById('session-form');
    const requiredFields = [
        document.getElementById('{{ form.year_name.id_for_label }}'),
        document.getElementById('term-selector'),
        document.getElementById('{{ form.start_date.id_for_label }}'),
        document.getElementById('{{ form.end_date.id_for_label }}')
    ];
    
    let isValid = true;
    
    // Clear previous validation states
    form.querySelectorAll('.is-invalid').forEach(field => {
        field.classList.remove('is-invalid');
    });
    
    // Check required fields
    requiredFields.forEach(field => {
        if (field && !field.value.trim()) {
            isValid = false;
            field.classList.add('is-invalid');
        }
    });
    
    // Validate dates
    const startDate = document.getElementById('{{ form.start_date.id_for_label }}').value;
    const endDate = document.getElementById('{{ form.end_date.id_for_label }}').value;
    
    if (startDate && endDate && new Date(startDate) >= new Date(endDate)) {
        isValid = false;
        document.getElementById('{{ form.start_date.id_for_label }}').classList.add('is-invalid');
        document.getElementById('{{ form.end_date.id_for_label }}').classList.add('is-invalid');
    }
    
    // Validate term selector
    const termSelector = document.getElementById('term-selector');
    if (termSelector && !termSelector.value) {
        isValid = false;
        termSelector.classList.add('is-invalid');
    }
    
    return isValid;
}

// Reset form
function resetForm() {
    if (confirm('Reset all form fields? Any unsaved changes will be lost.')) {
        const form = document.getElementById('session-form');
        form.reset();
        
        // Clear validation classes
        form.querySelectorAll('.is-valid, .is-invalid').forEach(field => {
            field.classList.remove('is-valid', 'is-invalid');
        });
        
        // Reset term selector
        const termSelector = document.getElementById('term-selector');
        if (termSelector) {
            termSelector.value = '';
        }
        
        // Clear hidden fields
        document.getElementById('{{ form.term_number.id_for_label }}').value = '';
        document.getElementById('{{ form.term_name.id_for_label }}').value = '';
        
        // Hide validation messages and previews
        document.getElementById('date-validation').style.display = 'none';
        document.getElementById('duration-info').style.display = 'none';
        document.getElementById('break-impact').style.display = 'none';
        document.getElementById('break-impact-preview').style.display = 'none';
        
        // Reset preview
        updatePreview();
    }
}

// Track form changes for unsaved changes warning
let formChanged = false;

document.getElementById('session-form').addEventListener('input', function() {
    formChanged = true;
});

document.getElementById('session-form').addEventListener('change', function() {
    formChanged = true;
});

// Warn about unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (formChanged && !document.getElementById('save-session').disabled) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
    }
});

// Form submitted successfully - remove warning
document.getElementById('session-form').addEventListener('submit', function() {
    formChanged = false;
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + S: Save form
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        document.getElementById('save-session').click();
    }
    
    // Ctrl/Cmd + R: Reset form (with confirmation)
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        resetForm();
    }
});
</script>

<!-- Print Styles for Form -->
<style media="print">
   .btn, .btn-group, .page-title-actions, .form-help {
       display: none !important;
   }
   .form-section {
       border: 1px solid #ddd !important;
       box-shadow: none !important;
       break-inside: avoid;
   }
   .preview-card {
       border: 1px solid #ddd !important;
       position: static !important;
   }
   @page {
       margin: 0.5in;
   }
   body {
       font-size: 12px;
   }
</style>

{% endblock %}